<!DOCTYPE html><html lang="zh-CN"><head><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><meta charset="utf-8"><title>php原生socket实现websocket聊天室</title><meta name="keywords" content="php,php原生socket,socket,通讯,服务端与客户端通讯,linux,socket原理,数据互通,系列文章,websocket"><meta name="description" content="本文介绍socket的原理与使用php原生方式的简单实现，php原生socket从入门到实战websocket聊天室，webSocket 协议是一种网络通信协议，全双工网络通信协议，html5支持，所有浏览器都兼容了此协议"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/style/main.css"><link rel="stylesheet" href="/style/gitalk.min.css"><link rel="stylesheet" href="/style/simple-lightbox.min.css"><link rel="alternate" href="/atom.xml" title="codeover" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="codeover" type="application/rss+xml"></head><body><div id="app" class="main"><div class="site-header-container"><div class="site-header"><div class="left"> <a href="https://www.codeover.cn"><img class="avatar" src="/images/avatar.png" alt="logo" width="32px" height="32px"></a><a href="https://www.codeover.cn"><h1 class="site-title">codeover</h1></a></div><div class="right"><i class="icon menu-switch icon-menu-outline"></i></div></div></div><div class="menu-container" style="height:0;opacity:0"><nav class="menu-list"> <a href="/" class="menu purple-link">首页</a> <a href="/tags/" class="menu purple-link">标签</a> <a href="/categories/" class="menu purple-link">分类</a> <a href="/archives/" class="menu purple-link">归档</a> <a href="/about/" class="menu purple-link">关于</a></nav></div><div class="content-container"><div class="post-detail"><h2 class="post-title">php原生socket实现websocket聊天室</h2><div class="post-info post-detail-info"><span><i class="icon icon-calendar-outline"></i> 2022-06-20</span><span><i class="icon icon-pricetags-outline"></i> <a href="/tags/php/">php ，</a> <a href="/tags/socket/">socket</a></span></div><div class="post-content-wrapper"><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这是一篇系列文章，文章列表：</p><ol><li><a href="https://www.codeover.cn/php-socket/">php原生socket实现客户端与服务端数据传输</a></li><li><a href="https://www.codeover.cn/php-socket-http/">php原生socket之IO多路复用以及实现web服务器</a></li><li>php原生socket实现websocket聊天室</li></ol><h3 id="websocket介绍"><a href="#websocket介绍" class="headerlink" title="websocket介绍"></a>websocket介绍</h3><p>webSocket 协议是一种网络通信协议，在 2008 年诞生，2011 年成为国际标准，<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455">RFC6455</a> 定义了它的通信标准，如今所有浏览器都已支持了该协议。webSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="footnote--top">[1]<content class="footnote--pop-ups">是通讯传输的一个术语。 通信允许数据在两个方向上同时传输，它在能力上相当于两个单工通信方式的结合</content></span></a></sup>通讯的协议，服务器可以主动向客户端推送消息，客户端也可以主动向服务端发送消息。<br>webSocket 约定了一个通信协议的规范，通过握手机制，客户端（浏览器）和服务器（webserver）之间能建立一个类似 tcp 的连接，从而方便 cs 通信。</p><h3 id="为什么需要websocket"><a href="#为什么需要websocket" class="headerlink" title="为什么需要websocket"></a>为什么需要websocket</h3><p>HTTP 协议是一种无状态的、无连接的、单向的应用层协议。它采用了 <code>请求 =&gt; 响应</code> 模型，通信请求仅能由客户端发起，服务端对请求做出应答处理，这种通信模型有一个弊端：无法实现服务端主动向客户端发起消息。传统的 HTTP 请求，其并发能力都是依赖同时发起多个 TCP 连接访问服务器实现的而 websocket 则允许我们在一条 ws 连接上同时并发多个请求，即在 A 请求发出后 A 响应还未到达，就可以继续发出 B 请求。由于 TCP 的慢启动特性，以及连接本身的握手损耗，都使得 websocket 协议的这一特性有很大的效率提升。</p> <a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/image-20220618222456220.png-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/image-20220618222456220.png-imageFop" alt="http与websocket对比" style="zoom:67%" lazyload=""></a><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ol><li>建立在 TCP 协议之上，服务端的实现相对比较容易</li><li>与 HTTP 协议有良好的兼容性，默认端口也是 80 和 443，并且握手阶段采用 HTTP 协议，因此握手时不容易被屏蔽，能通过各种 HTTP 代理服务器。</li><li>数据格式比较轻量，性能开销小，通信高效。</li><li>可以发送文本，也可以发送二进制数据。</li><li>没有同源限制，客户端可以与任意服务器进行通信。</li><li>协议标识符是 ws（如果加密则为 wss），服务地址就是 URL。</li></ol><h2 id="PHP实现websocket"><a href="#PHP实现websocket" class="headerlink" title="PHP实现websocket"></a>PHP实现websocket</h2><h3 id="客户端与服务端握手"><a href="#客户端与服务端握手" class="headerlink" title="客户端与服务端握手"></a>客户端与服务端握手</h3><p>websocket 协议在连接前需要握手<sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="footnote--top">[2]<content class="footnote--pop-ups">为了建立 websocket 连接，需要通过浏览器发出请求，之后服务器进行回应，这个过程通常称为“握手”（Handshaking）</content></span></a></sup>，通常握手方式有以下几种方式</p><ul><li><p>基于 flash 的握手协议（不建议）</p></li><li><p>基于 md5 加密方式的握手协议</p><p>较早的握手方法，有两个 key，使用 md5 加密</p></li><li><p>基于 sha1 加密方式的握手协议</p><p>当前主要的握手协议，本文将以此协议为主</p><ol><li>获取客户端上报的 <code>Sec-WebSocket-key</code></li><li>拼接 <code>key</code> + <code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code></li><li>对字符串做 <code>SHA1</code> 计算，再把得到的结果通过 <code>base64</code> 加密，最后再返回给客户端</li></ol></li></ul><p>客户端请求信息如下：</p><figure class="highlight http"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/chat</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>server.example.com</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key</span><span class="punctuation">: </span>dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://example.com</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span><span class="punctuation">: </span>chat, superchat</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span><span class="punctuation">: </span>13</span><br></pre></td></tr></tbody></table></figure><p>客户端需返回如下数据：</p><figure class="highlight http"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">101</span> Switching Protocols</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span><span class="punctuation">: </span>13</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Accept</span><span class="punctuation">: </span>s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br></pre></td></tr></tbody></table></figure><p>我们根据此协议通过 PHP 方式实现：</p><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$socket</span> = <span class="title function_ invoke__">socket_create</span>(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line"><span class="title function_ invoke__">socket_set_option</span>(<span class="variable">$socket</span>, SOL_SOCKET, SO_REUSEADDR, <span class="literal">true</span>);</span><br><span class="line"><span class="title function_ invoke__">socket_bind</span>(<span class="variable">$socket</span>, <span class="number">0</span>, <span class="number">8888</span>);</span><br><span class="line"><span class="title function_ invoke__">socket_listen</span>(<span class="variable">$socket</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">    <span class="variable">$conn_sock</span> = <span class="title function_ invoke__">socket_accept</span>(<span class="variable">$socket</span>);</span><br><span class="line">    <span class="variable">$request</span> = <span class="title function_ invoke__">socket_read</span>(<span class="variable">$conn_sock</span>, <span class="number">102400</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$new_key</span> = <span class="title function_ invoke__">getShaKey</span>(<span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$response</span> = <span class="string">"HTTP/1.1 101 Switching Protocols\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Upgrade: websocket\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Version: 13\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Connection: Upgrade\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Accept: <span class="subst">{$new_key}</span>\r\n\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">socket_write</span>(<span class="variable">$conn_sock</span>, <span class="variable">$response</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getShaKey</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 获取 Sec-WebSocket-key</span></span><br><span class="line">    <span class="title function_ invoke__">preg_match</span>(<span class="string">"/Sec-WebSocket-Key: (.*)\r\n/"</span>, <span class="variable">$request</span>, <span class="variable">$match</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接 key + 258EAFA5-E914-47DA-95CA-C5AB0DC85B11</span></span><br><span class="line">    <span class="variable">$new_key</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$match</span>[<span class="number">1</span>]) . <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对字符串做 `SHA1` 计算，再把得到的结果通过 `base64` 加密</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$new_key</span>, <span class="literal">true</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>相关语法解释可参考 <a href="https://www.codeover.cn/php-socket/#%E8%AF%AD%E6%B3%95%E8%A7%A3%E9%87%8A">之前的文章</a>，本文章不做详细介绍。</p><p>使用前端测试，打开我们的任意浏览器控制台（console）输入以下内容，返回的 websocket 对象的 readyState 为 1 即为握手成功，此为前端内容，本文不多做介绍，详情可参考 <a target="_blank" rel="noopener" href="https://www.runoob.com/html/html5-websocket.html">菜鸟教程</a>：</p><figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">'ws://192.162.2.166:8888'</span>));</span><br><span class="line"><span class="comment">// 运行后返回：</span></span><br><span class="line"><span class="title class_">WebSocket</span> {</span><br><span class="line">    <span class="attr">binaryType</span>: <span class="string">"blob"</span></span><br><span class="line">    <span class="attr">bufferedAmount</span>: <span class="number">0</span></span><br><span class="line">    <span class="attr">extensions</span>: <span class="string">""</span></span><br><span class="line">    <span class="attr">onclose</span>: <span class="literal">null</span></span><br><span class="line">    <span class="attr">onerror</span>: <span class="literal">null</span></span><br><span class="line">    <span class="attr">onmessage</span>: <span class="literal">null</span></span><br><span class="line">    <span class="attr">onopen</span>: <span class="literal">null</span></span><br><span class="line">    <span class="attr">protocol</span>: <span class="string">""</span></span><br><span class="line">    <span class="attr">readyState</span>: <span class="number">1</span></span><br><span class="line">    <span class="attr">url</span>: <span class="string">"ws://192.162.2.166:8888/"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="发送数据与接收数据"><a href="#发送数据与接收数据" class="headerlink" title="发送数据与接收数据"></a>发送数据与接收数据</h3><p>使用 websocket 协议传输协议需要遵循特定的格式规范，详情请参考 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455#section-5.2">https://datatracker.ietf.org/doc/html/rfc6455#section-5.2</a></p><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/image-20220619231347489.png-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/image-20220619231347489.png-imageFop" alt="发送数据与接收数据" lazyload=""></a></p><p>为了方便，这里直接贴出加解密代码，以下代码借鉴与 <a target="_blank" rel="noopener" href="https://github.com/walkor/workerman/">workerman</a> 的 <code>src/Protocols/Websocket.php</code> 文件：</p><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 解码客户端发送的消息</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$len</span> = \<span class="title function_ invoke__">ord</span>(<span class="variable">$buffer</span>[<span class="number">1</span>]) &amp; <span class="number">127</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">126</span>) {</span><br><span class="line">        <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">8</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">127</span>) {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">14</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">6</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$dataLength</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="variable">$masks</span> = \<span class="title function_ invoke__">str_repeat</span>(<span class="variable">$masks</span>, \<span class="title function_ invoke__">floor</span>(<span class="variable">$dataLength</span> / <span class="number">4</span>)) . \<span class="title function_ invoke__">substr</span>(<span class="variable">$masks</span>, <span class="number">0</span>, <span class="variable">$dataLength</span> % <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span> ^ <span class="variable">$masks</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编码发送给客户端的消息</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$buffer</span>)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">"You can't send("</span> . \<span class="title function_ invoke__">gettype</span>(<span class="variable">$buffer</span>) . <span class="string">") to client, you need to convert it to a string. "</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$len</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$buffer</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$first_byte</span> = <span class="string">"\x81"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">125</span>) {</span><br><span class="line">        <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">65535</span>) {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">126</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"n"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">127</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"xxxxN"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$encode_buffer</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>我们修改刚才 <a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8F%A1%E6%89%8B">客户端与服务端握手</a> 阶段的代码，修改后全代码全文如下，该段代码实现了将客户端发送的消息转为大写后返回给客户端（当然只是为了演示）：</p><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$socket</span> = <span class="title function_ invoke__">socket_create</span>(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line"><span class="title function_ invoke__">socket_set_option</span>(<span class="variable">$socket</span>, SOL_SOCKET, SO_REUSEADDR, <span class="literal">true</span>);</span><br><span class="line"><span class="title function_ invoke__">socket_bind</span>(<span class="variable">$socket</span>, <span class="number">0</span>, <span class="number">8888</span>);</span><br><span class="line"><span class="title function_ invoke__">socket_listen</span>(<span class="variable">$socket</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">    <span class="variable">$conn_sock</span> = <span class="title function_ invoke__">socket_accept</span>(<span class="variable">$socket</span>);</span><br><span class="line">    <span class="variable">$request</span> = <span class="title function_ invoke__">socket_read</span>(<span class="variable">$conn_sock</span>, <span class="number">102400</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$new_key</span> = <span class="title function_ invoke__">getShaKey</span>(<span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$response</span> = <span class="string">"HTTP/1.1 101 Switching Protocols\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Upgrade: websocket\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Version: 13\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Connection: Upgrade\r\n"</span>;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Accept: <span class="subst">{$new_key}</span>\r\n\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送握手数据</span></span><br><span class="line">    <span class="title function_ invoke__">socket_write</span>(<span class="variable">$conn_sock</span>, <span class="variable">$response</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新增内容，获取客户端发送的消息并转为大写还给客户端</span></span><br><span class="line">    <span class="variable">$msg</span> = <span class="title function_ invoke__">socket_read</span>(<span class="variable">$conn_sock</span>, <span class="number">102400</span>);</span><br><span class="line">    <span class="title function_ invoke__">socket_write</span>(<span class="variable">$conn_sock</span>, <span class="title function_ invoke__">encode</span>(<span class="title function_ invoke__">strtoupper</span>(<span class="title function_ invoke__">decode</span>(<span class="variable">$msg</span>))));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getShaKey</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 获取 Sec-WebSocket-key</span></span><br><span class="line">    <span class="title function_ invoke__">preg_match</span>(<span class="string">"/Sec-WebSocket-Key: (.*)\r\n/"</span>, <span class="variable">$request</span>, <span class="variable">$match</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接 key + 258EAFA5-E914-47DA-95CA-C5AB0DC85B11</span></span><br><span class="line">    <span class="variable">$new_key</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$match</span>[<span class="number">1</span>]) . <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对字符串做 `SHA1` 计算，再把得到的结果通过 `base64` 加密</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$new_key</span>, <span class="literal">true</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="variable">$len</span> = \<span class="title function_ invoke__">ord</span>(<span class="variable">$buffer</span>[<span class="number">1</span>]) &amp; <span class="number">127</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">126</span>) {</span><br><span class="line">        <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">8</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">127</span>) {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">14</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">6</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$dataLength</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="variable">$masks</span> = \<span class="title function_ invoke__">str_repeat</span>(<span class="variable">$masks</span>, \<span class="title function_ invoke__">floor</span>(<span class="variable">$dataLength</span> / <span class="number">4</span>)) . \<span class="title function_ invoke__">substr</span>(<span class="variable">$masks</span>, <span class="number">0</span>, <span class="variable">$dataLength</span> % <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span> ^ <span class="variable">$masks</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$buffer</span>)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">"You can't send("</span> . \<span class="title function_ invoke__">gettype</span>(<span class="variable">$buffer</span>) . <span class="string">") to client, you need to convert it to a string. "</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$len</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$buffer</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$first_byte</span> = <span class="string">"\x81"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">125</span>) {</span><br><span class="line">        <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">65535</span>) {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">126</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"n"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">127</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"xxxxN"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$encode_buffer</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>使用 <a target="_blank" rel="noopener" href="http://www.websocket-test.com/">在线测试工具</a> 进行测试，可以看到消息已经可以正常发送接收，接下来的文章将继续优化代码，实现简易聊天室，敬请关注：</p><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/GIF2022-6-2023-53-02.gif-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/GIF2022-6-2023-53-02.gif-imageFop" alt="测试截图" lazyload=""></a></p><h2 id="实现web聊天室"><a href="#实现web聊天室" class="headerlink" title="实现web聊天室"></a>实现web聊天室</h2><p>我们紧接着上文的代码继续优化，以实现简易的web聊天室</p><h3 id="多路复用"><a href="#多路复用" class="headerlink" title="多路复用"></a>多路复用</h3><p>其实就是加一下 <code>socket_select()</code> 函数 <span class="github-emoji"><span>😂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8" aria-hidden="true" onerror='this.parent.classList.add("github-emoji-fallback")'></span> ，本文就不写原理与语法了，详情可参考 <a href="https://www.codeover.cn/php-socket-http/#%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8">之前的文章</a>，以下代码修改自前文 <a href="#%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E4%B8%8E%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE">发送数据与接收数据</a></p><figure class="highlight diff"><table><tbody><tr><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">socket_listen($socket);</span><br><span class="line"></span><br><span class="line"><span class="addition">+$sockets[] = $socket;</span></span><br><span class="line"><span class="addition">+$user = [];</span></span><br><span class="line">while (true) {</span><br><span class="line"><span class="addition">+   $tmp_sockets = $sockets;</span></span><br><span class="line"><span class="addition">+   socket_select($tmp_sockets, $write, $except, null);</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+   foreach ($tmp_sockets as $sock) {</span></span><br><span class="line"><span class="addition">+       if ($sock == $socket) {</span></span><br><span class="line"><span class="addition">+           $sockets[] = socket_accept($socket);</span></span><br><span class="line"><span class="addition">+           $user[] = ['socket' =&gt; $socket, 'handshake' =&gt; false];</span></span><br><span class="line"><span class="addition">+       } else {</span></span><br><span class="line"><span class="addition">+           $curr_user = $user[array_search($sock, $user)];</span></span><br><span class="line"><span class="addition">+           if ($curr_user['handshake']) { // 已握手</span></span><br><span class="line"><span class="addition">+               $msg = socket_read($sock, 102400);</span></span><br><span class="line"><span class="addition">+               echo '客户端发来消息' . decode($msg);</span></span><br><span class="line"><span class="addition">+               socket_write($sock, encode('这是来自服务端的消息'));</span></span><br><span class="line"><span class="addition">+           } else {</span></span><br><span class="line"><span class="addition">+               // 握手</span></span><br><span class="line"><span class="addition">+           }</span></span><br><span class="line"><span class="addition">+       }</span></span><br><span class="line"><span class="addition">+   }</span></span><br><span class="line"></span><br><span class="line"><span class="deletion">-   $conn_sock = socket_accept($socket);</span></span><br><span class="line"><span class="deletion">-   $request = socket_read($conn_sock, 102400);</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><h3 id="实现聊天室"><a href="#实现聊天室" class="headerlink" title="实现聊天室"></a>实现聊天室</h3><p>最终成果演示</p><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/GIF2022-6-2323-15-24.gif-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/GIF2022-6-2323-15-24.gif-imageFop" alt="websocket成果演示" lazyload=""></a></p><p>我们将上述代码改造成类，并在类变量储存用户信息，添加消息处理等逻辑，最后贴出代码，建议保存下来自己尝试一下，也许会有全新的认知，后端代码：</p><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">WebSocket</span>();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Websocket</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> resource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$socket</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array 用户列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$user</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array 存放所有 socket 资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$socket_list</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;socket = <span class="title function_ invoke__">socket_create</span>(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line">        <span class="title function_ invoke__">socket_set_option</span>(<span class="variable">$this</span>-&gt;socket, SOL_SOCKET, SO_REUSEADDR, <span class="literal">true</span>);</span><br><span class="line">        <span class="title function_ invoke__">socket_bind</span>(<span class="variable">$this</span>-&gt;socket, <span class="number">0</span>, <span class="number">8888</span>);</span><br><span class="line">        <span class="title function_ invoke__">socket_listen</span>(<span class="variable">$this</span>-&gt;socket);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 socket 资源放入 socket_list</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;socket_list[] = <span class="variable language_">$this</span>-&gt;socket;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            <span class="variable">$tmp_sockets</span> = <span class="variable language_">$this</span>-&gt;socket_list;</span><br><span class="line">            <span class="title function_ invoke__">socket_select</span>(<span class="variable">$tmp_sockets</span>, <span class="variable">$write</span>, <span class="variable">$except</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$tmp_sockets</span> <span class="keyword">as</span> <span class="variable">$sock</span>) {</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$sock</span> == <span class="variable language_">$this</span>-&gt;socket) {</span><br><span class="line">                    <span class="variable">$conn_sock</span> = <span class="title function_ invoke__">socket_accept</span>(<span class="variable">$sock</span>);</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;socket_list[] = <span class="variable">$conn_sock</span>;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;user[] = [<span class="string">'socket'</span> =&gt; <span class="variable">$conn_sock</span>, <span class="string">'handshake'</span> =&gt; <span class="literal">false</span>, <span class="string">'name'</span> =&gt; <span class="string">'无名氏'</span>];</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="variable">$request</span> = <span class="title function_ invoke__">socket_read</span>(<span class="variable">$sock</span>, <span class="number">102400</span>);</span><br><span class="line">                    <span class="variable">$k</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getUserIndex</span>(<span class="variable">$sock</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable">$request</span>) {</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 用户端断开连接</span></span><br><span class="line">                    <span class="keyword">if</span> ((\<span class="title function_ invoke__">ord</span>(<span class="variable">$request</span>[<span class="number">0</span>]) &amp; <span class="number">0xf</span>) == <span class="number">0x8</span>) {</span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">close</span>(<span class="variable">$k</span>);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'handshake'</span>]) {</span><br><span class="line">                        <span class="comment">// 握手</span></span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">handshake</span>(<span class="variable">$k</span>, <span class="variable">$request</span>);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        <span class="comment">// 已握手</span></span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">send</span>(<span class="variable">$k</span>, <span class="variable">$request</span>);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭连接</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $k</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"><span class="variable">$k</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$u_name</span> = <span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'name'</span>] ?? <span class="string">'无名氏'</span>;</span><br><span class="line">        <span class="title function_ invoke__">socket_close</span>(<span class="variable">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'socket'</span>]);</span><br><span class="line">        <span class="variable">$socket_key</span> = <span class="title function_ invoke__">array_search</span>(<span class="variable">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'socket'</span>], <span class="variable">$this</span>-&gt;socket_list);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;socket_list[<span class="variable">$socket_key</span>]);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$user</span> = [];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;user <span class="keyword">as</span> <span class="variable">$v</span>) {</span><br><span class="line">            <span class="variable">$user</span>[] = <span class="variable">$v</span>[<span class="string">'name'</span>];</span><br><span class="line">        }</span><br><span class="line">        <span class="variable">$res</span> = [</span><br><span class="line">            <span class="string">'type'</span> =&gt; <span class="string">'close'</span>,</span><br><span class="line">            <span class="string">'users'</span> =&gt; <span class="variable">$user</span>,</span><br><span class="line">            <span class="string">'msg'</span> =&gt; <span class="variable">$u_name</span> . <span class="string">'已退出'</span>,</span><br><span class="line">            <span class="string">'time'</span> =&gt; <span class="title function_ invoke__">date</span>(<span class="string">'Y-m-d H:i:s'</span>)</span><br><span class="line">        ];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sendAllUser</span>(<span class="variable">$res</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户索引</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $socket</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserIndex</span>(<span class="params"><span class="variable">$socket</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;user <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$v</span>[<span class="string">'socket'</span>] == <span class="variable">$socket</span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$k</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 握手</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $k</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">handshake</span>(<span class="params"><span class="variable">$k</span>, <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="title function_ invoke__">preg_match</span>(<span class="string">"/Sec-WebSocket-Key: (.*)\r\n/"</span>, <span class="variable">$request</span>, <span class="variable">$match</span>);</span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$match</span>[<span class="number">1</span>] . <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span>, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$response</span> = <span class="string">"HTTP/1.1 101 Switching Protocols\r\n"</span>;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">"Upgrade: websocket\r\n"</span>;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">"Connection: Upgrade\r\n"</span>;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">"Sec-WebSocket-Accept: <span class="subst">{$key}</span>\r\n\r\n"</span>;</span><br><span class="line">        <span class="title function_ invoke__">socket_write</span>(<span class="variable">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'socket'</span>], <span class="variable">$response</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'handshake'</span>] = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收并处理消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $k</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $msg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"><span class="variable">$k</span>, <span class="variable">$msg</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$msg</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">decode</span>(<span class="variable">$msg</span>);</span><br><span class="line">        <span class="variable">$msg</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$msg</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$msg</span>[<span class="string">'type'</span>])) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$msg</span>[<span class="string">'type'</span>]) {</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'login'</span>: <span class="comment">// 登录</span></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'name'</span>] = <span class="variable">$msg</span>[<span class="string">'name'</span>] ?? <span class="string">'无名氏'</span>;</span><br><span class="line">                <span class="variable">$users</span> = [];</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;user <span class="keyword">as</span> <span class="variable">$v</span>) {</span><br><span class="line">                    <span class="variable">$users</span>[] = <span class="variable">$v</span>[<span class="string">'name'</span>];</span><br><span class="line">                }</span><br><span class="line">                <span class="variable">$res</span> = [</span><br><span class="line">                    <span class="string">'type'</span> =&gt; <span class="string">'login'</span>,</span><br><span class="line">                    <span class="string">'name'</span> =&gt; <span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'name'</span>],</span><br><span class="line">                    <span class="string">'msg'</span> =&gt; <span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'name'</span>] . <span class="string">': login success'</span>,</span><br><span class="line">                    <span class="string">'users'</span> =&gt; <span class="variable">$users</span>,</span><br><span class="line">                ];</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sendAllUser</span>(<span class="variable">$res</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'message'</span>: <span class="comment">// 接收并发送消息</span></span><br><span class="line">                <span class="variable">$res</span> = [</span><br><span class="line">                    <span class="string">'type'</span> =&gt; <span class="string">'message'</span>,</span><br><span class="line">                    <span class="string">'name'</span> =&gt; <span class="variable language_">$this</span>-&gt;user[<span class="variable">$k</span>][<span class="string">'name'</span>] ?? <span class="string">'无名氏'</span>,</span><br><span class="line">                    <span class="string">'msg'</span> =&gt; <span class="variable">$msg</span>[<span class="string">'msg'</span>],</span><br><span class="line">                    <span class="string">'time'</span> =&gt; <span class="title function_ invoke__">date</span>(<span class="string">'H:i:s'</span>),</span><br><span class="line">                ];</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sendAllUser</span>(<span class="variable">$res</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送给所有人</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendAllUser</span>(<span class="params"><span class="variable">$msg</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$msg</span>)) {</span><br><span class="line">            <span class="variable">$msg</span> = <span class="title function_ invoke__">json_encode</span>(<span class="variable">$msg</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="variable">$msg</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">encode</span>(<span class="variable">$msg</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;user <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) {</span><br><span class="line">            <span class="title function_ invoke__">socket_write</span>(<span class="variable">$v</span>[<span class="string">'socket'</span>], <span class="variable">$msg</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$msg</span>));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $buffer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$len</span> = \<span class="title function_ invoke__">ord</span>(<span class="variable">$buffer</span>[<span class="number">1</span>]) &amp; <span class="number">127</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">126</span>) {</span><br><span class="line">            <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">8</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">127</span>) {</span><br><span class="line">                <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line">                <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">14</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="variable">$masks</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">                <span class="variable">$data</span> = \<span class="title function_ invoke__">substr</span>(<span class="variable">$buffer</span>, <span class="number">6</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="variable">$dataLength</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="variable">$masks</span> = \<span class="title function_ invoke__">str_repeat</span>(<span class="variable">$masks</span>, \<span class="title function_ invoke__">floor</span>(<span class="variable">$dataLength</span> / <span class="number">4</span>)) . \<span class="title function_ invoke__">substr</span>(<span class="variable">$masks</span>, <span class="number">0</span>, <span class="variable">$dataLength</span> % <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span> ^ <span class="variable">$masks</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$buffer</span>)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">"You can't send("</span> . \<span class="title function_ invoke__">gettype</span>(<span class="variable">$buffer</span>) . <span class="string">") to client, you need to convert it to a string. "</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="variable">$len</span> = \<span class="title function_ invoke__">strlen</span>(<span class="variable">$buffer</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$first_byte</span> = <span class="string">"\x81"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">125</span>) {</span><br><span class="line">            <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">65535</span>) {</span><br><span class="line">                <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">126</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"n"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="variable">$encode_buffer</span> = <span class="variable">$first_byte</span> . \<span class="title function_ invoke__">chr</span>(<span class="number">127</span>) . \<span class="title function_ invoke__">pack</span>(<span class="string">"xxxxN"</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$encode_buffer</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>前端代码如下（前端内容不在本文讨论范围之内，具体可参考 <a target="_blank" rel="noopener" href="https://www.runoob.com/html/html5-websocket.html">菜鸟教程</a>）：</p><figure class="highlight html"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh-CN"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">content</span>=<span class="string">"width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">h3</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">justify-content</span>: center;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">30px</span> auto;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.but-box</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">justify-content</span>: center;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">align-items</span>: center;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-top</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#box</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">5px</span> auto;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: <span class="number">1px</span> <span class="number">#ccc</span> solid;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">400px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">700px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">overflow-x</span>: hidden;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">position</span>: relative;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#msg-box</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">480px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: <span class="number">111px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">overflow-x</span>: hidden;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#user-box</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">110px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">overflow-x</span>: hidden;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">float</span>: left;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-left</span>: <span class="number">1px</span> <span class="number">#ccc</span> solid;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background-color</span>: <span class="number">#F1F1F1</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">button</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">float</span>: right;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">80px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">35px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-size</span>: <span class="number">18px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">input</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">2px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">line-height</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">outline</span>: none;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: solid <span class="number">1px</span> <span class="number">#CCC</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.but-box</span> <span class="selector-tag">p</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: <span class="number">160px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>这是一个php socket实现的web聊天室<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"box"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"msg-box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"user-box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"but-box"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">cols</span>=<span class="string">"60"</span> <span class="attr">rows</span>=<span class="string">"3"</span> <span class="attr">style</span>=<span class="string">"resize:none;pedding: 10px"</span>    <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span> <span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"send"</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/jquery/2.2.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">'ws://124.222.85.67:8888'</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    ws.<span class="property">onopen</span> = <span class="keyword">function</span> (<span class="params">event</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'连接成功'</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> name = <span class="title function_">prompt</span>(<span class="string">'请输入用户名:'</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>({</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="string">'login'</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">name</span>: name</span></span><br><span class="line"><span class="language-javascript">        }));</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (!name) {</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">'好你个坏蛋，竟然没有输入用户名'</span>);</span></span><br><span class="line"><span class="language-javascript">        }</span></span><br><span class="line"><span class="language-javascript">    };</span></span><br><span class="line"><span class="language-javascript">    ws.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(event.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">switch</span> (data.<span class="property">type</span>) {</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">case</span> <span class="string">'close'</span>:</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">case</span> <span class="string">'login'</span>:</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">"#user-box"</span>).<span class="title function_">html</span>(<span class="string">''</span>);</span></span><br><span class="line"><span class="language-javascript">                data.<span class="property">users</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">item</span>) {</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">"#user-box"</span>).<span class="title function_">append</span>(<span class="string">`&lt;p style="color: grey;"&gt;<span class="subst">${item}</span>&lt;/p&gt;`</span>);</span></span><br><span class="line"><span class="language-javascript">                });</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (data.<span class="property">msg</span>) {</span></span><br><span class="line"><span class="language-javascript">                    $(<span class="string">"#msg-box"</span>).<span class="title function_">append</span>(<span class="string">`&lt;p style="color: grey;"&gt;<span class="subst">${data.msg}</span>&lt;/p&gt;`</span>);</span></span><br><span class="line"><span class="language-javascript">                }</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">case</span> <span class="string">'message'</span>:</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">"#msg-box"</span>).<span class="title function_">append</span>(<span class="string">`&lt;p&gt;&lt;span style="color: #0A89FF"&gt;<span class="subst">${data.time}</span>&lt;/span&gt;&lt;span style="color: red"&gt;<span class="subst">${data.name}</span>&lt;/span&gt;<span class="subst">${data.msg}</span>&lt;/p&gt;`</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">        }</span></span><br><span class="line"><span class="language-javascript">    };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    ws.<span class="property">onclose</span> = <span class="keyword">function</span> (<span class="params">event</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(<span class="string">'连接关闭'</span>);</span></span><br><span class="line"><span class="language-javascript">    };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">onkeydown</span> = <span class="keyword">function</span> (<span class="params">event</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (event.<span class="property">keyCode</span> == <span class="number">13</span>) {</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">send</span>();</span></span><br><span class="line"><span class="language-javascript">        }</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="string">"#send"</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">send</span>();</span></span><br><span class="line"><span class="language-javascript">    });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">send</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> content = $(<span class="string">"#content"</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">"#content"</span>).<span class="title function_">val</span>(<span class="string">''</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (!content) {</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">        }</span></span><br><span class="line"><span class="language-javascript">        ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>({</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="string">'message'</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">msg</span>: content</span></span><br><span class="line"><span class="language-javascript">        }));</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none;padding-left:0;margin-left:40px"><li id="fn:1"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">1.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">是通讯传输的一个术语。 通信允许数据在两个方向上同时传输，它在能力上相当于两个单工通信方式的结合 <a href="#fnref:1">↩</a></span></li><li id="fn:2"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">2.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">为了建立 websocket 连接，需要通过浏览器发出请求，之后服务器进行回应，这个过程通常称为“握手”（Handshaking） <a href="#fnref:2">↩</a></span></li></ol></div></div></div><div class="top-div"><ol class="top-box"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%89%8D%E8%A8%80"><span class="top-box-text">前言</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#websocket%E4%BB%8B%E7%BB%8D"><span class="top-box-text">websocket介绍</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81websocket"><span class="top-box-text">为什么需要websocket</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%89%B9%E7%82%B9"><span class="top-box-text">特点</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#PHP%E5%AE%9E%E7%8E%B0websocket"><span class="top-box-text">PHP实现websocket</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8F%A1%E6%89%8B"><span class="top-box-text">客户端与服务端握手</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E4%B8%8E%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE"><span class="top-box-text">发送数据与接收数据</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%AE%9E%E7%8E%B0web%E8%81%8A%E5%A4%A9%E5%AE%A4"><span class="top-box-text">实现web聊天室</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="top-box-text">多路复用</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%AE%9E%E7%8E%B0%E8%81%8A%E5%A4%A9%E5%AE%A4"><span class="top-box-text">实现聊天室</span></a></li></ol></li></ol></div></div></div><div class="next-post"><a class="purple-link" href="/php-socket-http/"><h3 class="post-title"> 下一篇：php原生socket之IO多路复用以及实现web服务器</h3></a></div></div><div id="gitalk-container"></div><footer><div class="site-footer"><div class="social-container"><a aria-label="跳转至github" href="https://github.com/f-dong" target="_blank"><i class="icon icon-github"></i></a></div> Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a> | <a href="https://beian.miit.gov.cn" target="_blank">豫ICP备2022011962号</a> | <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41010402002848" target="_blank">豫公网安备41010402002848号</a></div></footer></div><script id="hexo-configurations">window.theme_config={image:{lazyload_enable:!0,photo_zoom:"simple-lightbox"}},window.is_post=!0</script><script src="/js/main.js"></script><script src="/js/gitalk.min.js"></script><script>var gitalk=new Gitalk({clientID:"eaa8ec37487184406145",clientSecret:"77f9955d0267c1331df7cc706cfa385d2befb9c6",repo:"blog",owner:"f-dong",admin:["f-dong"],id:location.pathname.slice(1,location.pathname.lastIndexOf("/")).substring(0,49),distractionFreeMode:!1,createIssueManually:!0});gitalk.render("gitalk-container")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-2GM6102E19"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2GM6102E19")</script><script src="/js/simple-lightbox.min.js"></script><script>document.addEventListener("DOMContentLoaded",function(){new SimpleLightbox(".post-detail .simple-lightbox",{fileExt:!1,captionsData:"alt"})})</script></body></html>