<!DOCTYPE html><html lang="zh-CN"><head><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><meta charset="utf-8"><title>关于微信支付V3 PHP7.2以下实现方式</title><meta name="keywords" content="php,php微信支付,PHP7.2接入微信支付V3,微信支付APIV3,商家转账到零钱,linux,代码速记,平台证书下载,微信支付APIV3平台公钥下载"><meta name="description" content="PHP7.0接入微信支付V3，微信支付APIV3平台公钥下载，平台证书下载，大概是今年 4、5 月份开通 “微信代付” 也就是商户平台的钱通过接口转账到用户余额里这个功能，更新了一版，更新完之后接入方式与之前完全分离，也就是完全不一样了。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/style/main.css"><link rel="stylesheet" href="/style/gitalk.min.css"><link rel="stylesheet" href="/style/simple-lightbox.min.css"><link rel="alternate" href="/atom.xml" title="codeover" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="codeover" type="application/rss+xml"></head><body><div id="app" class="main"><div class="site-header-container"><div class="site-header"><div class="left"> <a href="https://www.codeover.cn"><img class="avatar" src="/images/avatar.png" alt="logo" width="32px" height="32px"></a><a href="https://www.codeover.cn"><h1 class="site-title">codeover</h1></a></div><div class="right"><i class="icon menu-switch icon-menu-outline"></i></div></div></div><div class="menu-container" style="height:0;opacity:0"><nav class="menu-list"> <a href="/" class="menu purple-link">首页</a> <a href="/tags/" class="menu purple-link">标签</a> <a href="/categories/" class="menu purple-link">分类</a> <a href="/archives/" class="menu purple-link">归档</a> <a href="/about/" class="menu purple-link">关于</a></nav></div><div class="content-container"><div class="post-detail"><h2 class="post-title">关于微信支付V3 PHP7.2以下实现方式</h2><div class="post-info post-detail-info"><span><i class="icon icon-calendar-outline"></i> 2022-06-28</span><span><i class="icon icon-pricetags-outline"></i> <a href="/tags/php/">php ，</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E9%80%9F%E8%AE%B0/">代码速记</a></span></div><div class="post-content-wrapper"><div class="post-content"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><blockquote><p>大概是今年 4、5 月份开通 “微信代付” 也就是商户平台的钱通过接口转账到用户余额里这个功能，更新了一版，更新完之后接入方式与之前完全分离，也就是完全不一样了。</p></blockquote><p>微信是我们项目中的一个小分支（非主线业务），前几天刚接到需求就在社区看到了 <a target="_blank" rel="noopener" href="https://learnku.com/articles/68805">关于微信支付V3 更新《企业打款到零钱》至《商户转账到零钱》</a> 这篇文章，原以为大佬已经铺路，这个需求已经稳了，真正开始做的时候才发现，支持微信支付 APIV3 的轮子最低都需要 PHP7.2（目前项目运行在PHP7.0）， 前文说过微信只是一小分支，如果影响主线业务估计就可以准备简历了，所以升级 PHP 版本是<strong>绝对不可能</strong>的，无奈，只能自己造轮子了</p><h3 id="新接口介绍"><a href="#新接口介绍" class="headerlink" title="新接口介绍"></a>新接口介绍</h3><p>前面哪位老哥发布的文章搞得我也是云里雾里的，文件A、文件C、字符串B傻傻分不清，这里我以自己的理解重新表述下各个配置的说明与获取方式（截图是取之前大哥的）</p><p>请求接口一共需要以下四项配置</p><ol><li><strong>API 证书</strong>，这个证书是与 APIV2 共用的，直接使用之前的配置即可，没申请直接按照步骤申请即可</li></ol><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/tbB1vlBoYs.png!large-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/tbB1vlBoYs.png!large-imageFop" alt="API 证书" lazyload=""></a></p><ol start="2"><li><strong>证书序列号</strong>，这个即上一步证书的序列号，在管理证书页面有显示，这个在 APIV2 内似乎没有用到（本人对微信业务不甚熟悉，如有误请指正）</li><li><strong>商户号</strong>，即微信支付的商户号</li></ol><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/Wl55facGUs.png!large-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/Wl55facGUs.png!large-imageFop" alt="商户号" lazyload=""></a></p><ol start="4"><li><strong>APIV3密钥</strong>，如图，设置自定义的32位字符</li></ol><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/f5ZHFBhUQm.png!large-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/f5ZHFBhUQm.png!large-imageFop" alt="APIV3密钥" lazyload=""></a></p><h3 id="平台公钥"><a href="#平台公钥" class="headerlink" title="平台公钥"></a>平台公钥</h3><p>关于第五项，平台公钥与平台公钥序列号，相信是大家一头雾水的源头，因为这个证书只能通过接口获取（无法通过商户后台获取），这个文件主要起到以下两个作用</p><ol><li>加密敏感信息，微信接口文档会明确注明需要加密的字段</li></ol><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/BSpejkQewu.png!large-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/BSpejkQewu.png!large-imageFop" alt="加密敏感信息" lazyload=""></a></p><ol start="2"><li>请求验签，这里指的是同步请求结果的验签，异步回调的报文是密文，使用应用私钥解密，不需验签<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="footnote--top">[1]<content class="footnote--pop-ups">OpenSSL的加密签名方式为公钥加密私钥解密，私钥签名公钥验证，所以所有的解密、加签操作都需要<strong>应用私钥</strong>的参与，同样的，所有的验签、加密操作也都需要<strong>平台公钥</strong>的参与</content></span></a></sup></li></ol><p>如果以上两项都不需要，即可忽略平台公钥，同时 APIV3 密钥也不再需要（APIV3密钥仅用于获取平台公钥），也就是说，只需要同等于 APIV2 的配置即可调用 APIV3 接口。</p><p>例如只接入转账接口且不验证用户真实姓名，并信任<sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="footnote--top">[2]<content class="footnote--pop-ups">这里的信任是指忽略请求微信服务端的过程中请求被拦截篡改的情况</content></span></a></sup>微信的返回结果</p><p>如果还是需要平台公钥，可直接查看下文代码中的 <code>getPlatformCertificate</code> 方法</p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>如果 PHP 版本小于 7.1，则需要安装 <a target="_blank" rel="noopener" href="https://github.com/jedisct1/libsodium-php">libsodium-php</a> 扩展，该扩展是 <a target="_blank" rel="noopener" href="https://pecl.php.net/package/libsodium">PECL</a> 扩展，直接编译安装即可，该扩展用户解密平台公钥，如不需平台公钥则可忽略</p><p>提醒一下：这个过程还是有很大风险的，因为需要修改 <code>php.ini</code> 并且重启 <code>php-fpm</code>，我们的方案是在业务低峰期将部分服务器退出负载，待所有客户端断开连接后操作，随后由测试同学充分测试后恢复负载，以此往复。操作前一定要向 Leader 报备，以免面向监狱编程</p><h2 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2><p>最后的最后贴出代码供大家参考（如果业务需要验签，将 <code>jsonBased</code> 方法中的验签方法取消注释，并维护对应的平台公钥列表逻辑即可）：</p><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">common</span>\<span class="title class_">libs</span>\<span class="title class_">wechat</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">common</span>\<span class="title">libs</span>\<span class="title">wechat</span>\<span class="title">exception</span>\<span class="title">WechatPayV3Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">ClientInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Exception</span>\<span class="title">RequestException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Middleware</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">HandlerStack</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">RequestInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">ResponseInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">MessageInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Cache</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@var</span> int - The maximum clock offset in second */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MAXIMUM_CLOCK_OFFSET</span> = <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">WechatpayNonce</span> = <span class="string">'Wechatpay-Nonce'</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">WechatpaySerial</span> = <span class="string">'Wechatpay-Serial'</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">WechatpaySignature</span> = <span class="string">'Wechatpay-Signature'</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">WechatpayTimestamp</span> = <span class="string">'Wechatpay-Timestamp'</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ALGO_AES_256_GCM</span> = <span class="string">'aes-256-gcm'</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">AUTH_TAG_LENGTH_BYTE</span> = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeChatPayV3</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array The defaults configuration whose pased in `GuzzleHttp\Client`.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="variable">$defaults</span> = [</span><br><span class="line">        <span class="string">'base_uri'</span> =&gt; <span class="string">'https://api.mch.weixin.qq.com/'</span>,</span><br><span class="line">        <span class="string">'headers'</span> =&gt; [</span><br><span class="line">            <span class="string">'Accept'</span> =&gt; <span class="string">'application/json, text/plain, application/x-gzip'</span>,</span><br><span class="line">            <span class="string">'Content-Type'</span> =&gt; <span class="string">'application/json; charset=utf-8'</span>,</span><br><span class="line">        ],</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string The APIv3's platform public key.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$platform_serial_no</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$config</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;config = [</span><br><span class="line">            <span class="string">'app_id'</span> =&gt; <span class="variable">$config</span>[<span class="string">'app_id'</span>],</span><br><span class="line">            <span class="string">'ssl_key_path'</span> =&gt; <span class="variable">$config</span>[<span class="string">'ssl_key_path'</span>], <span class="comment">// 也可直接放私钥内容，修改下方即可</span></span><br><span class="line">            <span class="string">'mch_id'</span> =&gt; <span class="variable">$config</span>[<span class="string">'mch_id'</span>],</span><br><span class="line">            <span class="string">'serial_no'</span> =&gt; <span class="variable">$config</span>[<span class="string">'serial_no'</span>], <span class="comment">// 这个是应用私钥的序列号</span></span><br><span class="line">            <span class="string">'pay_sign_key'</span> =&gt; <span class="variable">$config</span>[<span class="string">'pay_sign_key'</span>], <span class="comment">// 这个是APIv3的密钥 32位的</span></span><br><span class="line"></span><br><span class="line">        ];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Merchant transfer an APIv3's</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter4_3_1.shtml</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $param</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|false|string</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> WechatPayV3Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$uri</span> = <span class="string">'v3/transfer/batches'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$param</span>[<span class="string">'out_detail_no'</span>]) || !<span class="keyword">isset</span>(<span class="variable">$param</span>[<span class="string">'transfer_amount'</span>]) || !<span class="keyword">isset</span>(<span class="variable">$param</span>[<span class="string">'openid'</span>])) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WechatPayV3Exception</span>(<span class="string">'Missing required parameters'</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="variable">$detail</span> = [</span><br><span class="line">            <span class="string">'out_detail_no'</span> =&gt; <span class="variable">$param</span>[<span class="string">'out_detail_no'</span>],</span><br><span class="line">            <span class="string">'transfer_amount'</span> =&gt; <span class="variable">$param</span>[<span class="string">'transfer_amount'</span>],</span><br><span class="line">            <span class="string">'transfer_remark'</span> =&gt; <span class="variable">$param</span>[<span class="string">'transfer_remark'</span>] ?? <span class="string">'转账'</span>,</span><br><span class="line">            <span class="string">'openid'</span> =&gt; <span class="variable">$param</span>[<span class="string">'openid'</span>],</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$param</span>[<span class="string">'user_name'</span>])) {</span><br><span class="line">            <span class="variable">$detail</span>[<span class="string">'user_name'</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">encryptedData</span>(<span class="variable">$param</span>[<span class="string">'user_name'</span>]);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="variable">$params</span> = [</span><br><span class="line">            <span class="string">'appid'</span> =&gt; <span class="variable language_">$this</span>-&gt;config[<span class="string">'app_id'</span>],</span><br><span class="line">            <span class="string">'out_batch_no'</span> =&gt; <span class="variable">$param</span>[<span class="string">'out_detail_no'</span>],</span><br><span class="line">            <span class="string">'batch_name'</span> =&gt; <span class="string">'转账'</span>,</span><br><span class="line">            <span class="string">'batch_remark'</span> =&gt; <span class="variable">$param</span>[<span class="string">'transfer_remark'</span>] ?? <span class="string">'转账'</span>,</span><br><span class="line">            <span class="string">'total_amount'</span> =&gt; <span class="variable">$param</span>[<span class="string">'transfer_amount'</span>],</span><br><span class="line">            <span class="string">'total_num'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'transfer_detail_list'</span> =&gt; [<span class="variable">$detail</span>],</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">request</span>(<span class="string">'POST'</span>, <span class="variable">$uri</span>, [<span class="string">'json'</span> =&gt; <span class="variable">$params</span>]);</span><br><span class="line">        } <span class="keyword">catch</span> (RequestException <span class="variable">$e</span>) {</span><br><span class="line">            <span class="variable">$err</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">toArray</span>(<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getResponse</span>());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WechatPayV3Exception</span>((<span class="variable">$err</span>[<span class="string">'message'</span>] ?? <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>()) . (<span class="variable">$err</span>[<span class="string">'code'</span>]), <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getCode</span>());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initiate an APIv3's request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $method The request method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $uri The request URI.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $options The request options.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $config The GuzzleHttp\Client configuration.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|false|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$method</span>, <span class="keyword">string</span> <span class="variable">$uri</span>, <span class="keyword">array</span> <span class="variable">$options</span> = [], <span class="keyword">array</span> <span class="variable">$config</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$method</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$method</span>);</span><br><span class="line">        <span class="variable">$response</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">jsonBased</span>(<span class="variable">$config</span>)-&gt;{<span class="variable">$method</span>}(<span class="variable">$uri</span>, <span class="variable">$options</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">toArray</span>(<span class="variable">$response</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create Wechat pay V3 client.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $config The GuzzleHttp\Client configuration.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Client</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">jsonBased</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$config</span> = []</span>): <span class="title">Client</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$privateKey</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;config[<span class="string">'ssl_key_path'</span>]); <span class="comment">// The merchant private key.</span></span><br><span class="line">        <span class="variable">$mchid</span> = <span class="variable language_">$this</span>-&gt;config[<span class="string">'mch_id'</span>]; <span class="comment">// The merchant ID</span></span><br><span class="line">        <span class="variable">$serial</span> = <span class="variable language_">$this</span>-&gt;config[<span class="string">'serial_no'</span>]; <span class="comment">// The serial number of the merchant certificate</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$handler</span> = <span class="keyword">isset</span>(<span class="variable">$config</span>[<span class="string">'handler'</span>]) &amp;&amp; (<span class="variable">$config</span>[<span class="string">'handler'</span>] <span class="keyword">instanceof</span> HandlerStack) ? (<span class="keyword">clone</span> <span class="variable">$config</span>[<span class="string">'handler'</span>]) : <span class="title class_">HandlerStack</span>::<span class="title function_ invoke__">create</span>();</span><br><span class="line">        <span class="variable">$handler</span>-&gt;<span class="title function_ invoke__">unshift</span>(<span class="title class_">Middleware</span>::<span class="title function_ invoke__">mapRequest</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">signer</span>((<span class="keyword">string</span>)<span class="variable">$mchid</span>, <span class="variable">$serial</span>, <span class="variable">$privateKey</span>)), <span class="string">'signer'</span>);</span><br><span class="line"><span class="comment">//        $handler-&gt;unshift(Middleware::mapResponse($this-&gt;verifier($certs)), 'verifier');</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$config</span>[<span class="string">'handler'</span>] = <span class="variable">$handler</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">Client</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">withDefaults</span>(<span class="variable">$config</span>)));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ResponseInterface $response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|string|false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params">ResponseInterface <span class="variable">$response</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$contentType</span> = <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">getHeaderLine</span>(<span class="string">'Content-Type'</span>);</span><br><span class="line">        <span class="variable">$contents</span> = <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">getBody</span>()-&gt;<span class="title function_ invoke__">getContents</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;headers = <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">getHeaders</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> !== <span class="title function_ invoke__">stripos</span>(<span class="variable">$contentType</span>, <span class="string">'json'</span>) || <span class="title function_ invoke__">stripos</span>(<span class="variable">$contentType</span>, <span class="string">'javascript'</span>)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">json_decode</span>(<span class="variable">$contents</span>, <span class="literal">true</span>);</span><br><span class="line">        } <span class="keyword">elseif</span> (<span class="literal">false</span> !== <span class="title function_ invoke__">stripos</span>(<span class="variable">$contentType</span>, <span class="string">'xml'</span>)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">json_encode</span>(<span class="title function_ invoke__">simplexml_load_string</span>(<span class="variable">$contents</span>)), <span class="literal">true</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$contents</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * signer middleware stack.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $mchid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $serial</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $privateKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> callable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">signer</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$mchid</span>, <span class="keyword">string</span> <span class="variable">$serial</span>, <span class="variable">$privateKey</span></span>): <span class="title">callable</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">RequestInterface <span class="variable">$request</span></span>) <span class="keyword">use</span> (<span class="params"><span class="variable">$privateKey</span>, <span class="variable">$mchid</span>, <span class="variable">$serial</span></span>) </span>{</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;platform_serial_no) {</span><br><span class="line">                <span class="variable">$request</span> = <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">withHeader</span>(WechatpaySerial, <span class="variable">$this</span>-&gt;platform_serial_no);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="variable">$timestamp</span> = <span class="title function_ invoke__">time</span>();</span><br><span class="line">            <span class="variable">$nonce</span> = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">uniqid</span>((<span class="keyword">string</span>)<span class="title function_ invoke__">rand</span>(), <span class="literal">true</span>)), <span class="title function_ invoke__">mt_rand</span>(<span class="number">1</span>, <span class="number">16</span>), <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$body</span> = <span class="string">''</span>;</span><br><span class="line">            <span class="variable">$bodyStream</span> = <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">getBody</span>();</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$bodyStream</span>-&gt;<span class="title function_ invoke__">isSeekable</span>()) {</span><br><span class="line">                <span class="variable">$body</span> = (<span class="keyword">string</span>)<span class="variable">$bodyStream</span>;</span><br><span class="line">                <span class="variable">$bodyStream</span>-&gt;<span class="title function_ invoke__">rewind</span>();</span><br><span class="line">            }</span><br><span class="line">            <span class="variable">$sign_data</span> = <span class="title function_ invoke__">implode</span>(<span class="string">"\n"</span>, <span class="title function_ invoke__">array_merge</span>([<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">getMethod</span>(), <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">getRequestTarget</span>(), <span class="variable">$timestamp</span>, <span class="variable">$nonce</span>, <span class="variable">$body</span>], [<span class="string">''</span>]));</span><br><span class="line">            <span class="title function_ invoke__">openssl_sign</span>(<span class="variable">$sign_data</span>, <span class="variable">$signature</span>, <span class="variable">$privateKey</span>, <span class="string">'sha256WithRSAEncryption'</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">withHeader</span>(<span class="string">'Authorization'</span>, <span class="title function_ invoke__">sprintf</span>(</span><br><span class="line">                <span class="string">'WECHATPAY2-SHA256-RSA2048 mchid="%s",serial_no="%s",timestamp="%s",nonce_str="%s",signature="%s"'</span>,</span><br><span class="line">                <span class="variable">$mchid</span>, <span class="variable">$serial</span>, <span class="variable">$timestamp</span>, <span class="variable">$nonce</span>, <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$signature</span>)</span><br><span class="line">            ));</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * verifier middleware stack.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Closure</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">verifier</span>(<span class="params"><span class="keyword">array</span> &amp;<span class="variable">$certs</span></span>): <span class="title">callable</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">ResponseInterface <span class="variable">$response</span></span>) <span class="keyword">use</span> (<span class="params">&amp;<span class="variable">$certs</span></span>): <span class="title">ResponseInterface</span> </span>{</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$response</span>-&gt;<span class="title function_ invoke__">hasHeader</span>(WechatpayNonce) &amp;&amp; <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">hasHeader</span>(WechatpaySerial)</span><br><span class="line">                &amp;&amp; <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">hasHeader</span>(WechatpaySignature) &amp;&amp; <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">hasHeader</span>(WechatpayTimestamp))) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WechatPayV3Exception</span>(<span class="string">'Invalid response headers'</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$nonce</span>) = <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">getHeader</span>(WechatpayNonce);</span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$serial</span>) = <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">getHeader</span>(WechatpaySerial);</span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$signature</span>) = <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">getHeader</span>(WechatpaySignature);</span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$timestamp</span>) = <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">getHeader</span>(WechatpayTimestamp);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$localTimestamp</span> = <span class="title function_ invoke__">time</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">abs</span>(<span class="variable">$localTimestamp</span> - <span class="title function_ invoke__">intval</span>(<span class="variable">$timestamp</span>)) &gt; MAXIMUM_CLOCK_OFFSET) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WechatPayV3Exception</span>(<span class="string">'超出服务器时间误差范围'</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$serial</span>, <span class="variable">$certs</span>)) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WechatPayV3Exception</span>(<span class="string">'微信返回的序列号不存在'</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((<span class="variable">$result</span> = <span class="title function_ invoke__">openssl_verify</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">joinedByLineFeed</span>(<span class="variable">$timestamp</span>, <span class="variable">$nonce</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">body</span>(<span class="variable">$response</span>)), <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$signature</span>), <span class="variable">$certs</span>[<span class="variable">$serial</span>], <span class="string">'sha256WithRSAEncryption'</span>)) === <span class="literal">false</span>) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WechatPayV3Exception</span>(<span class="string">'验证签名失败'</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Formatting the body of the response.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $timestamp</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $nonce</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $body</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">joinedByLineFeed</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$timestamp</span>, <span class="keyword">string</span> <span class="variable">$nonce</span>, <span class="keyword">string</span> <span class="variable">$body</span> = <span class="string">''</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">implode</span>(<span class="string">"\n"</span>, [<span class="variable">$timestamp</span>, <span class="variable">$nonce</span>, <span class="variable">$body</span>]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Taken body string.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> MessageInterface $message - The message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">body</span>(<span class="params">MessageInterface <span class="variable">$message</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$body</span> = <span class="string">''</span>;</span><br><span class="line">        <span class="variable">$bodyStream</span> = <span class="variable">$message</span>-&gt;<span class="title function_ invoke__">getBody</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$bodyStream</span>-&gt;<span class="title function_ invoke__">isSeekable</span>()) {</span><br><span class="line">            <span class="variable">$body</span> = (<span class="keyword">string</span>)<span class="variable">$bodyStream</span>;</span><br><span class="line">            <span class="variable">$bodyStream</span>-&gt;<span class="title function_ invoke__">rewind</span>();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$body</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Deep merge the input with the defaults</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array&lt;string,string|int|bool|array|mixed&gt; $config - The configuration.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array&lt;string, string|mixed&gt; - With the built-in configuration.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">withDefaults</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$config</span> = []</span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">array_replace_recursive</span>(<span class="built_in">static</span>::<span class="variable">$defaults</span>, [<span class="string">'headers'</span> =&gt; <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">userAgent</span>()], <span class="variable">$config</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Prepare the `User-Agent` value key/value pair</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array&lt;string, string&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">userAgent</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$value</span> = [<span class="string">''</span>];</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">array_push</span>(<span class="variable">$value</span>, <span class="string">'GuzzleHttp/'</span> . <span class="title class_">ClientInterface</span>::<span class="variable constant_">VERSION</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">extension_loaded</span>(<span class="string">'curl'</span>) &amp;&amp; <span class="title function_ invoke__">function_exists</span>(<span class="string">'curl_version'</span>) &amp;&amp; <span class="title function_ invoke__">array_push</span>(<span class="variable">$value</span>, <span class="string">'curl/'</span> . ((<span class="keyword">array</span>)<span class="title function_ invoke__">curl_version</span>())[<span class="string">'version'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">array_push</span>(<span class="variable">$value</span>, <span class="title function_ invoke__">sprintf</span>(<span class="string">'(%s/%s) PHP/%s'</span>, PHP_OS, <span class="title function_ invoke__">php_uname</span>(<span class="string">'r'</span>), PHP_VERSION));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'User-Agent'</span> =&gt; <span class="title function_ invoke__">implode</span>(<span class="string">' '</span>, <span class="variable">$value</span>)];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sensitive information encryption.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> https://wechatpay-api.gitbook.io/wechatpay-api-v3/qian-ming-zhi-nan-1/min-gan-xin-xi-jia-mi</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $param</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> WechatPayV3Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">encryptedData</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$param</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$public_key</span> = <span class="title function_ invoke__">openssl_pkey_get_public</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">getPlatformCertificate</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">openssl_public_encrypt</span>(<span class="variable">$param</span>, <span class="variable">$encrypted</span>, <span class="variable">$public_key</span>, OPENSSL_PKCS1_OAEP_PADDING)) {</span><br><span class="line">            <span class="variable">$encrypted</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$encrypted</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">openssl_free_key</span>(<span class="variable">$public_key</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$encrypted</span> ?: <span class="string">''</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decrypt the encrypted data returned by APIv3.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_2.shtml</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $ciphertext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $iv</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $aad</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> WechatPayV3Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">decryptData</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$ciphertext</span>, <span class="keyword">string</span> <span class="variable">$key</span>, <span class="keyword">string</span> <span class="variable">$iv</span> = <span class="string">''</span>, <span class="keyword">string</span> <span class="variable">$aad</span> = <span class="string">''</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$ciphertext</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$ciphertext</span>);</span><br><span class="line">        <span class="variable">$authTag</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$ciphertext</span>, <span class="title function_ invoke__">intval</span>(-<span class="number">16</span>));</span><br><span class="line">        <span class="variable">$tagLength</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$authTag</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Manually checking the length of the tag, because the `openssl_decrypt` was mentioned there, it's the caller's responsibility. */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$tagLength</span> &gt; <span class="number">16</span> || (<span class="variable">$tagLength</span> &lt; <span class="number">12</span> &amp;&amp; <span class="variable">$tagLength</span> !== <span class="number">8</span> &amp;&amp; <span class="variable">$tagLength</span> !== <span class="number">4</span>)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WechatPayV3Exception</span>(<span class="string">'获取平台公钥失败，微信返回异常，请稍后再试'</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ext-sodium (default installed on &gt;= PHP 7.2)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">function_exists</span>(<span class="string">'\sodium_crypto_aead_aes256gcm_is_available'</span>) &amp;&amp; \<span class="title function_ invoke__">sodium_crypto_aead_aes256gcm_is_available</span>()) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="variable">$plaintext</span> = \<span class="title function_ invoke__">sodium_crypto_aead_aes256gcm_decrypt</span>(<span class="variable">$ciphertext</span>, <span class="variable">$aad</span>, <span class="variable">$iv</span>, <span class="variable">$key</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WechatPayV3Exception</span>(<span class="string">'解密失败，请稍后再试'</span>);</span><br><span class="line">            }</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ext-libsodium (need install libsodium-php 1.x via pecl)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">function_exists</span>(<span class="string">'\Sodium\crypto_aead_aes256gcm_is_available'</span>) &amp;&amp; \Sodium\<span class="title function_ invoke__">crypto_aead_aes256gcm_is_available</span>()) {</span><br><span class="line">            <span class="variable">$plaintext</span> = \Sodium\<span class="title function_ invoke__">crypto_aead_aes256gcm_decrypt</span>(<span class="variable">$ciphertext</span>, <span class="variable">$aad</span>, <span class="variable">$iv</span>, <span class="variable">$key</span>);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">        <span class="comment">// openssl (PHP &gt;= 7.1 support AEAD)</span></span><br><span class="line">        <span class="keyword">if</span> (PHP_VERSION_ID &gt;= <span class="number">70100</span> &amp;&amp; <span class="title function_ invoke__">in_array</span>(ALGO_AES_256_GCM, \<span class="title function_ invoke__">openssl_get_cipher_methods</span>())) {</span><br><span class="line">            <span class="variable">$ctext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$ciphertext</span>, <span class="number">0</span>, -AUTH_TAG_LENGTH_BYTE);</span><br><span class="line">            <span class="variable">$authTag</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$ciphertext</span>, -AUTH_TAG_LENGTH_BYTE);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$plaintext</span> = \<span class="title function_ invoke__">openssl_decrypt</span>(<span class="variable">$ctext</span>, ALGO_AES_256_GCM, <span class="variable">$key</span>, OPENSSL_RAW_DATA, <span class="variable">$iv</span>, <span class="variable">$authTag</span>, <span class="variable">$aad</span>);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$plaintext</span>)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WechatPayV3Exception</span>(<span class="string">'服务器异常，请稍后再试'</span>);</span><br><span class="line">        } <span class="keyword">elseif</span> (<span class="keyword">empty</span>(<span class="variable">$plaintext</span>)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WechatPayV3Exception</span>(<span class="string">'解密失败，请检查apiV3的公钥是否正确'</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$plaintext</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get platform public key by APIv3's.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> WechatPayV3Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPlatformCertificate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$apiv3Key</span> = <span class="variable language_">$this</span>-&gt;config[<span class="string">'pay_sign_key'</span>];</span><br><span class="line">        <span class="variable">$cache_key</span> = <span class="string">'wechatpay_apiv3_cate_'</span> . <span class="variable">$apiv3Key</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$platformCertificate</span> = <span class="title class_">Cache</span>::<span class="title function_ invoke__">get</span>(<span class="variable">$cache_key</span>)) {</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;platform_serial_no = <span class="variable">$platformCertificate</span>[<span class="string">'serial_no'</span>];</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$platformCertificate</span>[<span class="string">'cate'</span>];</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="variable">$client</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">jsonBased</span>();</span><br><span class="line">        <span class="variable">$handler</span> = <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">getConfig</span>(<span class="string">'handler'</span>);</span><br><span class="line">        <span class="variable">$handler</span>-&gt;<span class="title function_ invoke__">remove</span>(<span class="string">'verifier'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$response</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">toArray</span>(<span class="variable">$client</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">'v3/certificates'</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (\<span class="title function_ invoke__">is_array</span>(<span class="variable">$response</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$response</span>[<span class="string">'data'</span>]) &amp;&amp; \<span class="title function_ invoke__">is_array</span>(<span class="variable">$response</span>[<span class="string">'data'</span>])) {</span><br><span class="line">            <span class="variable">$row</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$response</span>[<span class="string">'data'</span>]);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$cert</span> = <span class="variable">$row</span>[<span class="string">'encrypt_certificate'</span>];</span><br><span class="line">            <span class="variable">$cert</span> = [<span class="string">'serial_no'</span> =&gt; <span class="variable">$row</span>[<span class="string">'serial_no'</span>], <span class="string">'cate'</span> =&gt; <span class="built_in">static</span>::<span class="title function_ invoke__">decryptData</span>(<span class="variable">$cert</span>[<span class="string">'ciphertext'</span>], <span class="variable">$apiv3Key</span>, <span class="variable">$cert</span>[<span class="string">'nonce'</span>], <span class="variable">$cert</span>[<span class="string">'associated_data'</span>])];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;platform_serial_no = <span class="variable">$row</span>[<span class="string">'serial_no'</span>];</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Cache</span>::<span class="title function_ invoke__">set</span>(<span class="variable">$cache_key</span>, <span class="variable">$cert</span>, <span class="number">60</span> * <span class="number">60</span> * <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$cert</span>[<span class="string">'cate'</span>];</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WechatPayV3Exception</span>(<span class="string">'获取平台公钥失败，微信返回异常，请稍后再试'</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none;padding-left:0;margin-left:40px"><li id="fn:1"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">1.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">OpenSSL的加密签名方式为公钥加密私钥解密，私钥签名公钥验证，所以所有的解密、加签操作都需要<strong>应用私钥</strong>的参与，同样的，所有的验签、加密操作也都需要<strong>平台公钥</strong>的参与 <a href="#fnref:1">↩</a></span></li><li id="fn:2"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">2.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">这里的信任是指忽略请求微信服务端的过程中请求被拦截篡改的情况 <a href="#fnref:2">↩</a></span></li></ol></div></div></div><div class="top-div"><ol class="top-box"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E8%83%8C%E6%99%AF"><span class="top-box-text">背景</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E6%96%B0%E6%8E%A5%E5%8F%A3%E4%BB%8B%E7%BB%8D"><span class="top-box-text">新接口介绍</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%B9%B3%E5%8F%B0%E5%85%AC%E9%92%A5"><span class="top-box-text">平台公钥</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="top-box-text">注意事项</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81"><span class="top-box-text">实现代码</span></a></li></ol></div></div></div><div class="next-post"><a class="purple-link" href="/php-socket-websocket/"><h3 class="post-title"> 下一篇：php原生socket实现websocket聊天室</h3></a></div></div><div id="gitalk-container"></div><footer><div class="site-footer"><div class="social-container"><a aria-label="跳转至github" href="https://github.com/f-dong" target="_blank"><i class="icon icon-github"></i></a></div> Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a> | <a href="https://beian.miit.gov.cn" target="_blank">豫ICP备2022011962号</a> | <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41010402002848" target="_blank">豫公网安备41010402002848号</a></div></footer></div><script id="hexo-configurations">window.theme_config={image:{lazyload_enable:!0,photo_zoom:"simple-lightbox"}},window.is_post=!0</script><script src="/js/main.js"></script><script src="/js/gitalk.min.js"></script><script>var gitalk=new Gitalk({clientID:"eaa8ec37487184406145",clientSecret:"77f9955d0267c1331df7cc706cfa385d2befb9c6",repo:"blog",owner:"f-dong",admin:["f-dong"],id:location.pathname.slice(1,location.pathname.lastIndexOf("/")).substring(0,49),distractionFreeMode:!1,createIssueManually:!0});gitalk.render("gitalk-container")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-2GM6102E19"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2GM6102E19")</script><script src="/js/simple-lightbox.min.js"></script><script>document.addEventListener("DOMContentLoaded",function(){new SimpleLightbox(".post-detail .simple-lightbox",{fileExt:!1,captionsData:"alt"})})</script></body></html>