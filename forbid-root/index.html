<!DOCTYPE html><html lang="zh-CN"><head><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><meta charset="utf-8"><title>linux 禁止 root 登录与密钥登录配置</title><meta name="keywords" content="linux,linux禁止root登录,sudo,服务器安全,sudo配置,密钥登录,子账户登录"><meta name="description" content="为了安全起见，生产环境服务器通常禁止 root 用户的 ssh 连接，我们实际使用普通用户去连接，连接之后切换到 root 执行命令或使用 sudo 执行命令"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/style/main.css"><link rel="stylesheet" href="/style/gitalk.min.css"><link rel="stylesheet" href="/style/simple-lightbox.min.css"><link rel="alternate" href="/atom.xml" title="codeover" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="codeover" type="application/rss+xml"></head><body><div id="app" class="main"><div class="site-header-container"><div class="site-header"><div class="left"> <a href="https://www.codeover.cn"><img class="avatar" src="/images/avatar.png" alt="logo" width="32px" height="32px"></a><a href="https://www.codeover.cn"><h1 class="site-title">codeover</h1></a></div><div class="right"><i class="icon menu-switch icon-menu-outline"></i></div></div></div><div class="menu-container" style="height:0;opacity:0"><nav class="menu-list"> <a href="/" class="menu purple-link">首页</a> <a href="/tags/" class="menu purple-link">标签</a> <a href="/categories/" class="menu purple-link">分类</a> <a href="/archives/" class="menu purple-link">归档</a> <a href="/about/" class="menu purple-link">关于</a></nav></div><div class="content-container"><div class="post-detail"><h2 class="post-title">linux 禁止 root 登录与密钥登录配置</h2><div class="post-info post-detail-info"><span><i class="icon icon-calendar-outline"></i> 2022-06-04</span><span><i class="icon icon-pricetags-outline"></i> <a href="/tags/linux/">linux</a></span></div><div class="post-content-wrapper"><div class="post-content"><p>为了安全起见，生产环境服务器通常禁止 root 用户的 ssh 连接，这通常是防止服务器被暴力破解，我们实际使用普通用户去连接，然后切换到 root 执行命令或使用 sudo 执行命令。</p><h2 id="禁止root登录"><a href="#禁止root登录" class="headerlink" title="禁止root登录"></a>禁止root登录</h2><ol><li><p>创建子用户</p><p>在禁止 root 登录前，必须确保已经创建了一个子用户，尝试链接并登录成功，新增用户命令如下，其中 test 为新建的用户名：</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">useradd <span class="built_in">test</span> <span class="comment"># 添加用户</span></span><br><span class="line">passwd <span class="built_in">test</span> <span class="comment"># 设置用户密码</span></span><br></pre></td></tr></tbody></table></figure></li><li><p>修改 ssh 配置文件</p><p>ssh 配置文件位于 <code>/etc/ssh/sshd_config</code>，我们可使用 <code>vim</code> 等工具修改，在文件中修改 <code>PermitRootLogin yes</code> 为 <code>PermitRootLogin no</code> 即可</p></li><li><p>重启 ssh</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">service sshd restart</span><br></pre></td></tr></tbody></table></figure></li><li><p>修改 root 密码</p><p>如果你之前是使用密钥方式登录的 root 账户，此时务必重设一下 root 密码以防因遗忘密码导致无法切换至 root 账户</p></li></ol><h2 id="设置密钥登录"><a href="#设置密钥登录" class="headerlink" title="设置密钥登录"></a>设置密钥登录</h2><p>在上一步中我们已经禁用了 root 用户的 ssh 登录，但依然存在被暴力破解的可能性，此时我们就可以设置只允许通过密钥方式登录，并且可以将对应的公钥复制到多台服务器，实现一个私钥管理多台服务器的目的。</p><ol><li><p>制作密钥对</p><p>使用如下命令生成密钥对，如果已经有对应的密钥对可跳过此步骤：</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">ssh-keygen</span><br></pre></td></tr></tbody></table></figure><p><a class="simple-lightbox" target="_blank" rel="noopener" href="https://cdn.codeover.cn/img/image-20220604222022292.png-imageFop"><img src="/images/loading.svg" data-src="https://cdn.codeover.cn/img/image-20220604222022292.png-imageFop" alt="制作密钥对示例截图" lazyload=""></a></p></li><li><p>在服务器中安装公钥</p><p>如果你是通过上一步骤生成的密钥对，使用如下方式安装，如果自定义了生成路径，需将 <code>~/.ssh/id_rsa.pub</code> 替换为对应路径：</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/.ssh</span><br><span class="line"><span class="built_in">cat</span> ~/.ssh/id_rsa.pub &gt; authorized_keys</span><br></pre></td></tr></tbody></table></figure><p>如果已经之前已经有了对应的密钥对，将公钥内容上传至服务器并改名为 <code>~/.ssh/authorized_keys</code></p></li><li><p>修改 ssh 配置文件</p><p>使用 vim 等编辑器编辑 ssh 配置文件 <code>/etc/ssh/sshd_config</code>：</p><figure class="highlight diff"><table><tbody><tr><td class="code"><pre><span class="line"><span class="deletion">- #PubkeyAuthentication yes</span></span><br><span class="line"><span class="addition">+ RSAAuthentication yes</span></span><br><span class="line"><span class="addition">+ PubkeyAuthentication yes</span></span><br></pre></td></tr></tbody></table></figure></li><li><p>下载私钥至客户端</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">yum install lrzsz -y</span><br><span class="line">sz ~/.ssh/id_rsa</span><br></pre></td></tr></tbody></table></figure><p>为了安全起见，将文件妥善保存后，删除服务器内的私钥文件</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">rm</span> -f ~/.ssh/id_rsa</span><br></pre></td></tr></tbody></table></figure></li><li><p>重启 ssh</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">service sshd restart</span><br></pre></td></tr></tbody></table></figure></li><li><p>禁用密码登录</p><p>在完成以上步骤后，使用密钥进行连接测试，确认无误后即可禁止密码方式登录，修改配置文件 <code>/etc/ssh/sshd_config</code>：</p><figure class="highlight diff"><table><tbody><tr><td class="code"><pre><span class="line"># To disable tunneled clear text passwords, change to no here!</span><br><span class="line">#PasswordAuthentication yes</span><br><span class="line">#PermitEmptyPasswords no</span><br><span class="line"><span class="deletion">- PasswordAuthentication yes</span></span><br><span class="line"><span class="addition">+ PasswordAuthentication no</span></span><br></pre></td></tr></tbody></table></figure></li></ol><h2 id="sudo-配置"><a href="#sudo-配置" class="headerlink" title="sudo 配置"></a>sudo 配置</h2><p>在上文中我们介绍了禁止 root 用户登录与密钥登录的配置，但我们执行一些操作时就需要切换至 root 用户，这会造成一定的误操作风险，此时我们就可以配置 sudo 实现不切换 root 操作一些系统命令，sudo 的主要配置文件位于 <code>/etc/sudoers</code>，可使用 vim 等编辑该文件</p><p>其主要语法为：</p><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">test ALL=(ALL) NOPASSWD: ALL</span><br></pre></td></tr></tbody></table></figure><ul><li><p><code>test</code> 指定对应用户名或用户组名，如果填写的是用户组，则需要在前添加 <code>%</code>，例如：<code>%test</code></p></li><li><p><code>ALL=(ALL)</code> 指定该用户或用户组可执行的命令，其中 <code>(ALL)</code> 代表该用户或组可执行所有命令，如需指定可执行的命令，将其替换为想让该用户执行的命令即可，多条命令用 <code>,</code> 分隔。例如：<code>ALL=/etc/init.d/mysqld,/etc/init.d/tengine,/etc/init.d/php81 restart</code></p></li><li><p><code>NOPASSWD: ALL</code> 该项为可选项，指定执行哪些命令可以不确定执行者密码，语法与上一项一致，如果配置此项，则上一项必须配置为 <code>ALL=(ALL)</code>，否则在执行 sudo 时会报错</p></li></ul><blockquote><p>注意：如果使用 vim 编辑该文件，在保存时需要添加 <code>!</code>，如：<code>:wq!</code></p></blockquote></div><div class="top-div"><ol class="top-box"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E7%A6%81%E6%AD%A2root%E7%99%BB%E5%BD%95"><span class="top-box-text">禁止root登录</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E8%AE%BE%E7%BD%AE%E5%AF%86%E9%92%A5%E7%99%BB%E5%BD%95"><span class="top-box-text">设置密钥登录</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#sudo-%E9%85%8D%E7%BD%AE"><span class="top-box-text">sudo 配置</span></a></li></ol></div></div></div><div class="next-post"><a class="purple-link" href="/linux-ftp-config/"><h3 class="post-title"> 下一篇：linux 安装 vsftpd 服务以及配置全攻略</h3></a></div></div><div id="gitalk-container"></div><footer><div class="site-footer"><div class="social-container"><a href="https://github.com/f-dong" target="_blank"><i class="icon icon-github"></i></a></div> Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a> | <a class="icp" href="https://beian.miit.gov.cn" target="_blank">豫ICP备2022011962号</a> | <a class="icp" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41010402002848" target="_blank">豫公网安备41010402002848号</a></div></footer></div><script id="hexo-configurations">window.theme_config={image:{lazyload_enable:!0,photo_zoom:"simple-lightbox"}},window.is_post=!0</script><script src="/js/main.js"></script><script src="/js/gitalk.min.js"></script><script>var gitalk=new Gitalk({clientID:"eaa8ec37487184406145",clientSecret:"77f9955d0267c1331df7cc706cfa385d2befb9c6",repo:"blog",owner:"f-dong",admin:["f-dong"],id:location.pathname.slice(1,location.pathname.lastIndexOf("/")).substring(0,49),distractionFreeMode:!1,createIssueManually:!0});gitalk.render("gitalk-container")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-2GM6102E19"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2GM6102E19")</script><script src="/js/simple-lightbox.min.js"></script><script>document.addEventListener("DOMContentLoaded",function(){new SimpleLightbox(".post-detail .simple-lightbox",{fileExt:!1,captionsData:"alt"})})</script></body></html>