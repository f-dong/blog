<!DOCTYPE html><html><head><meta charset="utf-8"><title>rsync 配置和使用</title><meta name="keywords" content="rsync,rsync配置,文件同步,数据备份,同步,linux rsync,数据恢复,运维,linux文件同步,代码部署"><meta name="description" content="rsync 是 linux 系统下的数据镜像备份工具，可以快速增量备份，支持远程同步、本地复制，或者与其他 ssh、rsync主机同步。rsync 具有安全性高、备份迅速、支持增量备份等诸多优点"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/style/main.css"><link rel="stylesheet" href="/style/fontawesome.css"><link rel="stylesheet" href="/style/jquery.fancybox.min.css"><link rel="stylesheet" href="/style/gitalk.css"><script async src="https://www.googletagmanager.com/gtag/js?id=G-2GM6102E19"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2GM6102E19")</script><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style><link rel="alternate" href="/atom.xml" title="codeover" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="codeover" type="application/rss+xml"></head><body><div id="app" class="main"><div class="site-header-container"><div class="site-header"><div class="left"> <a href="https://www.codeover.cn"><img class="avatar" src="/images/avatar.png" alt="" width="32px" height="32px"></a><a href="https://www.codeover.cn"><h1 class="site-title">codeover</h1></a></div><div class="right"><i class="icon menu-switch icon-menu-outline"></i></div></div></div><div class="menu-container" style="height:0;opacity:0"><nav class="menu-list"> <a href="/" class="menu purple-link">首页</a> <a href="/tags/" class="menu purple-link">标签</a> <a href="/categories/" class="menu purple-link">分类</a> <a href="/archives/" class="menu purple-link">归档</a> <a href="/about/" class="menu purple-link">关于</a></nav></div><div class="content-container"><div class="post-detail"><h2 class="post-title">rsync 配置和使用</h2><div class="post-info post-detail-info"><span><i class="icon-calendar-outline"></i> 2022-06-08</span><span><i class="icon-pricetags-outline"></i> <a href="/tags/linux/">linux</a></span></div><div class="post-content-wrapper"><div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>rsync 是 linux 系统下的数据镜像备份工具，可以快速增量备份，支持远程同步、本地复制，或者与其他 ssh、rsync主机同步。rsync 具有安全性高、备份迅速、支持增量备份等诸多优点，通过 rsync 可以解决对实时性要求不高的数据备份需求，例如定期备份服务器数据到远端服务器，对本地磁盘定期做数据镜像等。</p><h2 id="参数介绍"><a href="#参数介绍" class="headerlink" title="参数介绍"></a>参数介绍</h2><ul><li><code>-V</code> 展示详细的同步信息</li><li><code>-a</code> 归档模式，相当于 <code>-rlptgoD</code><ul><li><code>-r</code> 递归给定的目录</li><li><code>-l</code> 同步软连接文件</li><li><code>-p</code> 保留文件权限</li><li><code>-t</code> 同步源文件的修改时间</li><li><code>-g</code> 保持文件的所属用户组</li><li><code>-o</code> 保持文件所属的用户</li><li><code>-D</code> 保留设备文件与特殊文件</li></ul></li><li><code>-z</code> 压缩文件后再传输，减少网络带宽占用，但是会消耗一定的 cpu</li><li><code>-H</code> 保持硬链接</li><li><code>-n</code> 试运行，不做实际传输</li><li><code>-P</code> 相当于 <code>--partial --progress</code><ul><li><code>--partial</code> 支持断点续传</li><li><code>--progress</code> 传输时展示文件的传输进度</li></ul></li><li><code>--delete</code> 如果同步目录的文件被删除，同步删除目标文件</li><li><code>--delete-excluded</code> 在目标目录删除 <code>--exclude</code> 中指定的排除目录</li><li><code>--exclude</code> 要排除的路径，即不参与同步的路径</li><li><code>--exclude-from=FILE_PATH</code> 如果要排除的路径过多，可以统一写在一个文件内，并指定文件路径</li><li><code>-e ssh</code> 使用 ssh 加密隧道传输文件</li></ul><h2 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h2><h3 id="本地文件同步"><a href="#本地文件同步" class="headerlink" title="本地文件同步"></a>本地文件同步</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果目标目录（/tmp/desc/）不存在会自动创建目录</span></span><br><span class="line">rsync -av /tmp/test_dir/ /tmp/desc/</span><br></pre></td></tr></tbody></table></figure><h3 id="远程文件同步"><a href="#远程文件同步" class="headerlink" title="远程文件同步"></a>远程文件同步</h3><p>rsync 可以通过 ssh 隧道在不同服务器间同步数据，此方式只需其中一方安装 rsync 即可完成文件同步</p><ul><li>本地 =&gt; 远程</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -ave ssh /tmp/test_dir/ www@192.198.2.188:/tmp/desc/</span><br></pre></td></tr></tbody></table></figure><ul><li>远程 =&gt; 本地<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -ave ssh www@192.198.2.188:/tmp/desc/ /tmp/test_dir/</span><br></pre></td></tr></tbody></table></figure></li></ul><p>此命令执行后会要求输入 ssh 密码，可设置使用 <a href="https://www.codeover.cn/forbid-root/#%E8%AE%BE%E7%BD%AE%E5%AF%86%E9%92%A5%E7%99%BB%E5%BD%95">密钥登录</a> 方式免除密码，如下：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -ave <span class="string">"ssh -i /root/deploy_key"</span> /tmp/test_dir/ www@192.198.2.188:/tmp/desc/</span><br></pre></td></tr></tbody></table></figure><ul><li><code>-ave</code> 同 <code>-a -v -e</code></li><li><code>ssh -i /root/deploy_key</code> 使用 ssh 连接并指定连接使用的密钥文件 <code>/root/deploy_key</code>，引号内可使用 ssh 命令支持的参数，如 <code>-P</code>、<code>-y</code> 等</li><li><code>/tmp/test_dir/</code> 要传输目录</li><li><code>www@192.198.2.188:/tmp/desc/</code><ul><li><code>www</code> 连接 ssh 使用的用户名</li><li><code>192.198.2.188</code> 远端服务器 ip</li><li><code>/tmp/desc/</code> 传输目标路径</li></ul></li></ul><h2 id="服务监听模式"><a href="#服务监听模式" class="headerlink" title="服务监听模式"></a>服务监听模式</h2><p>rsync 可开启服务监听模式来完成远程文件同步，设置完成后可直接在两台服务器间同步数据，而无需使用 ssh 隧道连接。在一定程度上相较于 ssh 同步模式安全（只有文件同步权限，ssh 同步模式则有链接 ssh 的权限），但同时需要在其中一端持续运行监听 rsync，并且需要完成一定的配置后才能进行同步</p><h3 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h3><p>被连接的服务器为 rsync 的监听端（或称为服务端），即推送文件接收方或拉取文件的被拉取方需要在后台持续监听 rsync。</p><p>rsync 本身未提供配置文件，需要我们根据需要自行创建，其主要配置文件有以下三个：</p><ol><li><code>rsyncd.conf</code> 主配置文件</li><li><code>rsyncd.passwd</code> 用户名密码文件，一个用户一行，用户名与密码之间使用 <code>:</code> 分隔</li><li><code>rsyncd.motd</code> 连接成功后的欢迎信息，没什么用</li></ol><p>创建主配置文件，配置文件路径可以随意，在监听时指定即可，常用配置项如下：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置 pid 文件位置</span></span><br><span class="line"><span class="string">pid</span> <span class="string">file</span> <span class="string">=</span> <span class="string">/var/run/rsyncd.pid</span></span><br><span class="line"><span class="comment"># 指定 lock 文件位置</span></span><br><span class="line"><span class="string">lock</span> <span class="string">file</span> <span class="string">=</span> <span class="string">/var/run/rsync.lock</span></span><br><span class="line"><span class="string">uid</span> <span class="string">=</span> <span class="string">root</span></span><br><span class="line"><span class="string">gid</span> <span class="string">=</span> <span class="string">root</span></span><br><span class="line"><span class="comment"># chroot 为 yes 时必须使用 root 权限, 客户端连接模块，首先 chroot 到模块 path 参数指定的目录下，且不能备份 path 路径外的链接文件</span></span><br><span class="line"><span class="string">use</span> <span class="string">chroot</span> <span class="string">=</span> <span class="literal">yes</span></span><br><span class="line"><span class="comment"># 是否只读</span></span><br><span class="line"><span class="string">read</span> <span class="string">only</span> <span class="string">=</span> <span class="literal">no</span></span><br><span class="line"><span class="comment"># 是否只写</span></span><br><span class="line"><span class="string">write</span> <span class="string">only</span> <span class="string">=</span> <span class="literal">no</span></span><br><span class="line"><span class="comment"># 最大连接数</span></span><br><span class="line"><span class="string">max</span> <span class="string">connections</span> <span class="string">=</span> <span class="number">200</span></span><br><span class="line"><span class="comment"># 超时时间</span></span><br><span class="line"><span class="string">timeout</span> <span class="string">=</span> <span class="number">300</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下模块配置，可以多个，模块名称使用 [] 包裹</span></span><br><span class="line">[<span class="string">test</span>]</span><br><span class="line"><span class="comment"># 模块根目录, 即推送文件的路径，必须指定</span></span><br><span class="line"><span class="string">path</span> <span class="string">=</span> <span class="string">/var/test</span></span><br><span class="line"><span class="comment"># 忽略错误</span></span><br><span class="line"><span class="string">ignore</span> <span class="string">errors</span></span><br><span class="line"><span class="comment"># 是否只读</span></span><br><span class="line"><span class="string">read</span> <span class="string">only</span> <span class="string">=</span> <span class="literal">no</span></span><br><span class="line"><span class="comment"># 是否允许列出模块里的内容</span></span><br><span class="line"><span class="string">list</span> <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 允许推送的主机, 留空允许所有 ip</span></span><br><span class="line"><span class="string">host</span> <span class="string">allow</span> <span class="string">=</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"><span class="comment"># 模块验证用户名称, rsyncd.passwd 中指定的用户，非系统用户，可使用空格或者逗号隔开多个用户名</span></span><br><span class="line"><span class="string">auth</span> <span class="string">users</span> <span class="string">=</span> <span class="string">rsync</span></span><br><span class="line"><span class="comment"># 模块验证密码文件 可放在全局配置里</span></span><br><span class="line"><span class="string">secrets</span> <span class="string">file=/etc/rsync/rsyncd.passwd</span></span><br></pre></td></tr></tbody></table></figure><p>创建密码文件，一行一组用户名密码，用户名与密码之间使用 <code>:</code> 分隔，配置文件地址为主配置文件中指定的路径：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/rsync</span><br><span class="line"><span class="comment"># 创建一个 rsync 用户，密码为 123456</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"rsync:123456"</span> &gt; /etc/rsync/rsyncd.passwd</span><br><span class="line"><span class="comment"># 密码文件权限必须为 600，否则连接时会报错</span></span><br><span class="line"><span class="built_in">chmod</span> 600 /etc/rsync/rsyncd.passwd</span><br></pre></td></tr></tbody></table></figure><p>启动监听，在实际应用中可使用 <code>supervisor</code> 来确保服务不会中断：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/rsync/rsyncd.conf 为 rsync 主配置文件</span></span><br><span class="line"><span class="comment"># 如果未指定则默认取 /etc/rsyncd.conf</span></span><br><span class="line">rsync --daemon --config=/etc/rsync/rsyncd.conf</span><br></pre></td></tr></tbody></table></figure><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>客户端只需安装 rsync 即可完成同步，不需要进行复杂的配置</p><ul><li><p>从服务端同步到客户端，即从远端同步到本地</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz --delete rsync@192.198.2.188::<span class="built_in">test</span> /tmp/sync/</span><br></pre></td></tr></tbody></table></figure></li><li><p>从客户端同步到服务端，即从本地同步到远端</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz --delete /tmp/sync/ rsync@192.198.2.188::<span class="built_in">test</span></span><br></pre></td></tr></tbody></table></figure></li></ul><p>上述命令执行后会要求输入密码，密码即为服务端密码配置中的密码，使用得到账号必须在对应的模块注册过，详细参数解释：</p><ul><li><code>-avz</code> 同 <code>-a -v -z</code>，详情可参考前文 <a href="#%E5%8F%82%E6%95%B0%E4%BB%8B%E7%BB%8D">参数介绍</a></li><li><code>--delete</code> 如果本地目录删除了文件，同步删除远端文件</li><li><code>rsync@192.198.2.188::test</code><ul><li><code>rsync</code> 服务端模块配置中配置的用户名</li><li><code>192.198.2.188</code> 远端服务器地址，需要在远端主配置文件中允许当前 ip 同步</li><li><code>test</code> 服务端主配置文件中的模块名，即被 <code>[]</code> 包裹的内容</li></ul></li><li><code>/tmp/sync/</code> 本地目录地址，如果是 <code>/tmp/sync</code> 则同步目录，<code>/tmp/sync/</code> 则是同步目录中的内容。如果是从远端同步到本地且此目录不存在，则 rsync 会自动创建目录</li></ul><h4 id="免密码同步"><a href="#免密码同步" class="headerlink" title="免密码同步"></a>免密码同步</h4><p>上述命令在执行后会有一个输入密码的交互，在自动同步脚本中可以创建一个密码验证文件来跳过此交互，此文件中只需指定连接用户对应的密码即可：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建验证文件</span></span><br><span class="line"><span class="comment"># 假设服务端的密码为 123456</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"123456"</span> &gt; rsync.passwd</span><br><span class="line"><span class="comment"># 密码验证文件的权限必须为 600，否则在同步时会报错</span></span><br><span class="line"><span class="built_in">chmod</span> 600 rsync.passwd</span><br><span class="line"><span class="comment"># 指定密码验证文件</span></span><br><span class="line"><span class="comment"># 这里使用相对路径，实际使用中可以使用绝对路径</span></span><br><span class="line">rsync -avz --delete /tmp/sync/ rsync@192.198.2.188::<span class="built_in">test</span> --password-file=rsync.passwd</span><br></pre></td></tr></tbody></table></figure></div><div class="top-div"><ol class="top-box"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%8F%82%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="top-box-text">参数介绍</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="top-box-text">简单使用</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5"><span class="top-box-text">本地文件同步</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5"><span class="top-box-text">远程文件同步</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E6%9C%8D%E5%8A%A1%E7%9B%91%E5%90%AC%E6%A8%A1%E5%BC%8F"><span class="top-box-text">服务监听模式</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="top-box-text">服务端配置</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="top-box-text">客户端</span></a></li></ol></li></ol></div></div></div><div class="next-post"><a class="purple-link" href="/forbid-root/"><h3 class="post-title"> 下一篇：linux 禁止 root 登录与密钥登录配置</h3></a></div></div><div id="gitalk-container"></div><footer><div class="site-footer"><div class="social-container"><a href="https://github.com/f-dong" target="_blank"><i class="fab fa-github"></i></a></div> Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a> | <a class="icp" href="https://beian.miit.gov.cn" target="_blank">豫ICP备2022011962号</a> | <a class="icp" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41010402002848" target="_blank">豫公网安备41010402002848号</a></div></footer></div><script src="/js/jquery.min.js"></script><script src="/js/jquery.fancybox.min.js"></script><script src="/js/main.js"></script><script src="/js/gitalk.min.js"></script><script>var gitalk=new Gitalk({clientID:"eaa8ec37487184406145",clientSecret:"77f9955d0267c1331df7cc706cfa385d2befb9c6",repo:"blog",owner:"f-dong",admin:["f-dong"],id:location.pathname.slice(1,location.pathname.lastIndexOf("/")).substring(0,49),distractionFreeMode:!1,createIssueManually:!0});gitalk.render("gitalk-container")</script></body></html>