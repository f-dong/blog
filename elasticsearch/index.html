<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><title>Elasticsearch 全文搜索引擎基本使用</title><meta name="keywords" content="es,elasticsearch,全文搜索,elasticsearch 7,elasticsearch 8,分面搜索,同义词搜索,相似推荐,电商搜索,搜索引擎"><meta name="description" content="elasticsearch 8全文搜索与分面搜索, 常见的电商搜索方案，同义词搜索，分面搜索，相似商品推荐，php使用elasticsearch，laravel使用elasticsearch"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/style/main.css"><link rel="stylesheet" href="/style/jquery.fancybox.min.css"><link rel="stylesheet" href="/style/gitalk.css"><script async src="https://www.googletagmanager.com/gtag/js?id=G-2GM6102E19"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2GM6102E19")</script><link rel="alternate" href="/atom.xml" title="codeover" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="codeover" type="application/rss+xml"></head><body><div id="app" class="main"><div class="site-header-container"><div class="site-header"><div class="left"> <a href="https://www.codeover.cn"><img class="avatar" src="/images/avatar.png" alt="" width="32px" height="32px"></a><a href="https://www.codeover.cn"><h1 class="site-title">codeover</h1></a></div><div class="right"><i class="icon menu-switch icon-menu-outline"></i></div></div></div><div class="menu-container" style="height:0;opacity:0"><nav class="menu-list"> <a href="/" class="menu purple-link">首页</a> <a href="/tags/" class="menu purple-link">标签</a> <a href="/categories/" class="menu purple-link">分类</a> <a href="/archives/" class="menu purple-link">归档</a> <a href="/about/" class="menu purple-link">关于</a></nav></div><div class="content-container"><div class="post-detail"><h2 class="post-title">Elasticsearch 全文搜索引擎基本使用</h2><div class="post-info post-detail-info"><span><i class="icon icon-calendar-outline"></i> 2022-07-24</span><span><i class="icon icon-pricetags-outline"></i> <a href="/tags/php/">php ，</a> <a href="/tags/laravel/">laravel ，</a> <a href="/tags/es/">es</a></span></div><div class="post-content-wrapper"><div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Elasticsearch 是一个分布式的搜索和分析引擎，可以用于全文检索、结构化检索和分析，并能将这三者结合起来。Elasticsearch 基于 Lucene 开发，是 Lucene 的封装，提供了 REST API 的操作接口，开箱即用。现在是使用最广的开源搜索引擎之一，Wikipedia、Stack Overflow、GitHub 等都基于 Elasticsearch 来构建他们的搜索引擎。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>Elasticsearch 安装相对简单，只需安装 JDK<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="JDK 全称 **Java Development Kit**。它是 Java 语言的软件开发工具包，主要用于移动设备、嵌入式设备上的 java 应用程序。JDK 是整个 java 开发的核心，它包含了 JAVA 的运行环境（JVM+Java 系统类库）和 JAVA 工具。
">[1]</span></a></sup> 下载解压即可使用。</p><h3 id="安装-JDK"><a href="#安装-JDK" class="headerlink" title="安装 JDK"></a>安装 JDK</h3><figure class="highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">yum install java-1.8.0-openjdk <span class="comment"># 👈 CentOs</span></span><br><span class="line"></span><br><span class="line">apt-get install openjdk-8-jdk <span class="comment"># 👈 Ubuntu</span></span><br></pre></td></tr></tbody></table></figure><p>下载完后运行以下命令检查</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">java -version </span><br><span class="line"><span class="comment"># openjdk version "1.8.0_312"</span></span><br><span class="line"><span class="comment"># OpenJDK Runtime Environment (build 1.8.0_312-b07)</span></span><br><span class="line"><span class="comment"># OpenJDK 64-Bit Server VM (build 25.312-b07, mixed mode)</span></span><br></pre></td></tr></tbody></table></figure><h3 id="下载并安装-Elasticsearch"><a href="#下载并安装-Elasticsearch" class="headerlink" title="下载并安装 Elasticsearch"></a>下载并安装 Elasticsearch</h3><ul><li><p>打开网址：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch">https://www.elastic.co/cn/downloads/past-releases#elasticsearch</a></p></li><li><p>选择适合的版本点击 Download 按钮，本文选择安装 8.2.3 版本「截止发文 ik 插件最新版为 8.2.3」</p><p><img src="https://cdn.codeover.cn/img/image-20220724220810173.png-imageFop" alt="下载流程"></p></li><li><p>选择 LINUX X86_64 右键点击复制链接</p><p><img src="https://cdn.codeover.cn/img/image-20220724221803766.png-imageFop" alt="复制链接截图"></p></li><li><p>使用 <code>wget</code> 命令下载并解压到你喜欢的路径</p><figure class="highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 此过程在国内服务器较为缓慢</span></span><br><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.2.3-linux-x86_64.tar.gz -O elasticsearch.tar.gz</span><br><span class="line">tar -zxvf elasticsearch.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 elasticsearch 移动到 elasticsearch 目录</span></span><br><span class="line"><span class="built_in">mv</span> elasticsearch /www/server/elasticsearch</span><br></pre></td></tr></tbody></table></figure></li></ul><h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>Elasticsearch 不可以使用 root 用户运行，所以在执行以下命令前需要切换至普通用户，并赋予该用户对应命令的执行权限</p><figure class="highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">/www/server/elasticsearch/bin/elasticsearch -d</span><br></pre></td></tr></tbody></table></figure><h3 id="连接测试"><a href="#连接测试" class="headerlink" title="连接测试"></a>连接测试</h3><figure class="highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">curl <span class="string">'http://localhost:9200/?pretty'</span></span><br></pre></td></tr></tbody></table></figure><p>如果一切正常，将会返回类似如下格式内容</p><figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"name"</span> <span class="punctuation">:</span> <span class="string">"VM-12-15-centos"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"cluster_name"</span> <span class="punctuation">:</span> <span class="string">"elasticsearch"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"cluster_uuid"</span> <span class="punctuation">:</span> <span class="string">"pYjA-9oFTpGhS295HBxpOg"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"version"</span> <span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"number"</span> <span class="punctuation">:</span> <span class="string">"8.2.3"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"build_flavor"</span> <span class="punctuation">:</span> <span class="string">"default"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"build_type"</span> <span class="punctuation">:</span> <span class="string">"tar"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"build_hash"</span> <span class="punctuation">:</span> <span class="string">"9905bfb62a3f0b044948376b4f607f70a8a151b4"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"build_date"</span> <span class="punctuation">:</span> <span class="string">"2022-06-08T22:21:36.455508792Z"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"build_snapshot"</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"lucene_version"</span> <span class="punctuation">:</span> <span class="string">"9.1.0"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"minimum_wire_compatibility_version"</span> <span class="punctuation">:</span> <span class="string">"7.17.0"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"minimum_index_compatibility_version"</span> <span class="punctuation">:</span> <span class="string">"7.0.0"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"tagline"</span> <span class="punctuation">:</span> <span class="string">"You Know, for Search"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p>如果遇到报错，是因为 Elasticsearch 8 默认开启了 X-Pack<sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="x-pack 是 elasticsearch 的一个扩展包，集安全，警告，监视，图形和报告功能于一体，可以轻松的启用或者关闭一些功能。">[2]</span></a></sup>，因其不在本文的讨论范围，故现将其关闭，编辑文件 <code>config/elasticsearch.yml</code> 在 98 行左右将 <code>xpack.security.enabled: false</code> 修改为 <code>false</code>，如图</p><p><img src="https://cdn.codeover.cn/img/image-20220724233806934.png-imageFop" alt="修改配置"></p><h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><p>Elasticsearch 是一个基于文档的 NoSQL 数据库，是一个 <code>分布式</code>、<code>RESTful</code>风格的搜索和数据分析引擎，同时也是 <code>Elastic Stack</code> 的核心，集中存储数据。Elasticsearch、Logstash、Kibana 经常被用作日志分析系统，俗称 ELK。</p><p>说白了就是一个数据库，既然是数据库，有一些概念是互通的，如下表：</p><table><thead><tr><th>MySQL</th><th>Elasticsearch</th></tr></thead><tbody><tr><td>表（Table）</td><td>索引（Index）</td></tr><tr><td>记录（Row）</td><td>文档（Document）</td></tr><tr><td>字段（Column）</td><td>字段（Fields）</td></tr></tbody></table><h3 id="基础操作"><a href="#基础操作" class="headerlink" title="基础操作"></a>基础操作</h3><p>以下为 Elasticsearch 常用的 API，其中 <code>{index_name}</code> 代表自定义的索引名称，<code>{id}</code> 为文档的 ID「Elasticsearch 的 ID 并非自增，所以需要自行指定」。Elasticsearch 的返回值是 JSON 格式，在对应地址后添加 <code>?pretty</code> 即可获取格式化的 JSON 内容</p><table><thead><tr><th>请求方式</th><th>请求路径</th><th>说明</th></tr></thead><tbody><tr><td>PUT</td><td><code>/{index_name}</code></td><td>创建索引</td></tr><tr><td>GET</td><td><code>/{index_name}</code></td><td>查看索引信息</td></tr><tr><td>PUT</td><td><code>/{index_name}/_mapping</code></td><td>修改索引字段</td></tr><tr><td>PUT</td><td><code>{index_name}/_doc/{id}</code></td><td>创建\编辑文档</td></tr><tr><td>DELETE</td><td><code>{index_name}/_doc/{id}</code></td><td>删除文档</td></tr><tr><td>GET</td><td><code>{index_name}/_doc/{id}</code></td><td>读取文档数据</td></tr><tr><td>POST</td><td><code>{index_name}/_search</code></td><td>搜素数据</td></tr></tbody></table><h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -XPUT http://localhost:9200/test_index</span><br></pre></td></tr></tbody></table></figure><h4 id="查看索引信息"><a href="#查看索引信息" class="headerlink" title="查看索引信息"></a>查看索引信息</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl http://localhost:9200/test_index</span><br></pre></td></tr></tbody></table></figure><h4 id="为索引创建类型"><a href="#为索引创建类型" class="headerlink" title="为索引创建类型"></a>为索引创建类型</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -H<span class="string">'Content-Type: application/json'</span> -XPUT http://localhost:9200/test_index/_mapping -d<span class="string">'{</span></span><br><span class="line"><span class="string">  "properties": {</span></span><br><span class="line"><span class="string">    "title": { "type": "text", "analyzer": "ik_smart" }, </span></span><br><span class="line"><span class="string">    "description": { "type": "text", "analyzer": "ik_smart" },</span></span><br><span class="line"><span class="string">    "price": { "type": "scaled_float", "scaling_factor": 100 }</span></span><br><span class="line"><span class="string">  }</span></span><br><span class="line"><span class="string">}'</span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>properties</code> 表示这个索引中各个字段的定义，其中 <code>key</code> 是字段名称，<code>value</code> 是字段的定义<ul><li><code>type</code> 定义了字段的数据类型，常用的类型有 <code>text</code> / <code>integer</code> / <code>date</code> / <code>boolean</code> / <code>keyword</code>，可以在 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html">这个连接</a> 查看所有类型</li><li><code>analyzer</code> 告诉 Elasticsearch 使用什么方式给这个字段分词，示例中使用了 <code>ik_smart</code> ，这是一个中文分词器，后文会有介绍。</li></ul></li></ul><h4 id="创建文档"><a href="#创建文档" class="headerlink" title="创建文档"></a>创建文档</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -H<span class="string">'Content-Type: application/json'</span> -XPUT http://localhost:9200/test_index/_doc/1 -d<span class="string">'{</span></span><br><span class="line"><span class="string">    "title": "iPhone XR",</span></span><br><span class="line"><span class="string">    "description": "全新国产",</span></span><br><span class="line"><span class="string">    "price": 12800</span></span><br><span class="line"><span class="string">}'</span></span><br></pre></td></tr></tbody></table></figure><p>URL 中的 <code>1</code> 是文档的 ID，这点和 Mysql 不太一样，Elasticsearch 的文档 ID 不是自增的，需要我们手动指定。</p><h4 id="读取文档"><a href="#读取文档" class="headerlink" title="读取文档"></a>读取文档</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl http://localhost:9200/test_index/_doc/1</span><br></pre></td></tr></tbody></table></figure><p>URL 中的 <code>1</code> 即创建文档时的ID</p><h4 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -XPOST -H<span class="string">'Content-Type:application/json'</span> http://localhost:9200/test_index/_search?pretty -d<span class="string">'</span></span><br><span class="line"><span class="string">{</span></span><br><span class="line"><span class="string">    "query" : { "match" : { "description" : "全新" }}</span></span><br><span class="line"><span class="string">}'</span></span><br></pre></td></tr></tbody></table></figure><p>返回内容</p><figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"took"</span> <span class="punctuation">:</span> <span class="number">201</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"timed_out"</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"_shards"</span> <span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"total"</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"successful"</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"skipped"</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"failed"</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"hits"</span> <span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"total"</span> <span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"value"</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"relation"</span> <span class="punctuation">:</span> <span class="string">"eq"</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"max_score"</span> <span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"hits"</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"_index"</span> <span class="punctuation">:</span> <span class="string">"test_index"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"_id"</span> <span class="punctuation">:</span> <span class="string">"1"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"_score"</span> <span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"_source"</span> <span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">          <span class="attr">"title"</span> <span class="punctuation">:</span> <span class="string">"iPhone XR"</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">"description"</span> <span class="punctuation">:</span> <span class="string">"全新国产"</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">"price"</span> <span class="punctuation">:</span> <span class="number">12800</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p><code>ik_smart</code> 会把『全新国产』分词成『全新』和『国产』两个词，当我们用 <code>match</code> 来搜索时，Elasticsearch 就会拿搜索词在分词结果中寻找完全匹配的文档。</p><h3 id="Elasticsearch-查询"><a href="#Elasticsearch-查询" class="headerlink" title="Elasticsearch 查询"></a>Elasticsearch 查询</h3><h4 id="布尔查询"><a href="#布尔查询" class="headerlink" title="布尔查询"></a>布尔查询</h4><p>Elasticsearch 的布尔查询（Bool Query）与 SQL 语言中的 <code>and</code> / <code>or</code> 有些类似，可以根据多个条件来筛选文档。</p><p>布尔查询下可以有 4 类条件，每个类条件对应的项都是一个数组，数组内的每个项对应一个条件</p><ul><li><code>filter</code> 与 SQL 语句中的 <code>and</code> 类似，查询的文档必须同时满足类下的所有条件。</li><li><code>must</code> 与 <code>filter</code> 相同，区别在于 <code>must</code> 方法会参与 <em>打分</em>，而 <code>filter</code> 不会。</li><li><code>should</code> 查询条件不需完全满足，默认情况下只需要满足 <code>should</code> 下的一项即可，可以通过 <code>minimum_should_match</code> 参数来改变需要满足的个数，满足的条件越多对应文档的打分就越高。</li><li><code>must_not</code> 与 <code>must</code> 相反，查询的文档必须不符合此类下的所有条件。</li></ul><p>示例如下：</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -XPOST -H<span class="string">'Content-Type:application/json'</span> http://localhost:9200/test_index/_search?pretty -d<span class="string">'</span></span><br><span class="line"><span class="string">{</span></span><br><span class="line"><span class="string">	"query": {</span></span><br><span class="line"><span class="string">		"bool": {</span></span><br><span class="line"><span class="string">			"filter": [{</span></span><br><span class="line"><span class="string">				"match": {</span></span><br><span class="line"><span class="string">					"description": "全新"</span></span><br><span class="line"><span class="string">				}</span></span><br><span class="line"><span class="string">			}, {</span></span><br><span class="line"><span class="string">				"match": {</span></span><br><span class="line"><span class="string">					"title": "iPhone"</span></span><br><span class="line"><span class="string">				}</span></span><br><span class="line"><span class="string">			}]</span></span><br><span class="line"><span class="string">		}</span></span><br><span class="line"><span class="string">	}</span></span><br><span class="line"><span class="string">}'</span></span><br></pre></td></tr></tbody></table></figure><p>在上面的示例中，查询条件必须同时满足 <code>title</code> 包含 <code>iPhone</code> 且 <code>description</code> 包含 <code>全新</code></p><h4 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h4><p>分页是数据库查询的一项非常重要的功能，Elasticsearch 提供了 <code>from</code> 和 <code>size</code> 两个参数，其含义与 SQL 语句的 <code>limit $offset, $count</code> 语法中的 <code>$offset</code> 与 <code>$count</code> 参数完全一致。</p><p>示例如下：</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -XPOST -H<span class="string">'Content-Type:application/json'</span> http://localhost:9200/test_index/_search?pretty -d<span class="string">'</span></span><br><span class="line"><span class="string">{</span></span><br><span class="line"><span class="string">	"from": 0,</span></span><br><span class="line"><span class="string">	"size": 10,</span></span><br><span class="line"><span class="string">	"query": {</span></span><br><span class="line"><span class="string">		"bool": {</span></span><br><span class="line"><span class="string">			"filter": [{</span></span><br><span class="line"><span class="string">				"match": {</span></span><br><span class="line"><span class="string">					"description": "全新"</span></span><br><span class="line"><span class="string">				}</span></span><br><span class="line"><span class="string">			}]</span></span><br><span class="line"><span class="string">		}</span></span><br><span class="line"><span class="string">	}</span></span><br><span class="line"><span class="string">}'</span></span><br></pre></td></tr></tbody></table></figure><p>此示例中从第 0 个文档获取，共获取 10 个文档，返回数据中心的 <code>$results['hits']['hits']</code> 数组包含了此次查询符合条件的文档，<code>$results['hits']['total']['value']</code> 则代表整个索引中符合查询条件的文档数量。</p><h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><p>Elasticsearch 的排序很简单，只需要一个 <code>sort</code> 参数，<code>sort</code> 参数是一个数组，数组下的项可以有多种格式，我们常用的格式是 <code>key</code> <code>value</code> 数组，<code>key</code> 是要排序的字段，<code>value</code> 可以是 <code>desc</code> 或者 <code>asc</code>。</p><p>示例</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -XPOST -H<span class="string">'Content-Type:application/json'</span> http://localhost:9200/test_index/_search?pretty -d<span class="string">'</span></span><br><span class="line"><span class="string">{</span></span><br><span class="line"><span class="string">	"from": 0,</span></span><br><span class="line"><span class="string">	"size": 10,</span></span><br><span class="line"><span class="string">    "sort": [{"price": "desc"}],</span></span><br><span class="line"><span class="string">	"query": {</span></span><br><span class="line"><span class="string">		"bool": {</span></span><br><span class="line"><span class="string">			"filter": [{</span></span><br><span class="line"><span class="string">				"match": {</span></span><br><span class="line"><span class="string">					"description": "全新"</span></span><br><span class="line"><span class="string">				}</span></span><br><span class="line"><span class="string">			}]</span></span><br><span class="line"><span class="string">		}</span></span><br><span class="line"><span class="string">	}</span></span><br><span class="line"><span class="string">}'</span></span><br></pre></td></tr></tbody></table></figure><p>该示例使用 <code>price</code> 对查询结果进行排序。</p><h4 id="多字段匹配查询"><a href="#多字段匹配查询" class="headerlink" title="多字段匹配查询"></a>多字段匹配查询</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -XPOST -H<span class="string">'Content-Type:application/json'</span> http://localhost:9200/test_index/_search?pretty -d<span class="string">'</span></span><br><span class="line"><span class="string">{</span></span><br><span class="line"><span class="string">	"from": 0,</span></span><br><span class="line"><span class="string">	"size": 10,</span></span><br><span class="line"><span class="string">    "sort": [{"price": "desc"}],</span></span><br><span class="line"><span class="string">	"query": {</span></span><br><span class="line"><span class="string">		"bool": {</span></span><br><span class="line"><span class="string">			"must": [{</span></span><br><span class="line"><span class="string">				"multi_match": {</span></span><br><span class="line"><span class="string">					"query": "全新",</span></span><br><span class="line"><span class="string">					"fields": ["title^2", "description"]</span></span><br><span class="line"><span class="string">				}</span></span><br><span class="line"><span class="string">			}]</span></span><br><span class="line"><span class="string">		}</span></span><br><span class="line"><span class="string">	}</span></span><br><span class="line"><span class="string">}'</span></span><br></pre></td></tr></tbody></table></figure><p>该示例同时搜索 <code>title</code> 与 <code>description</code> 字段，其中 <code>title</code> 字段的权重为 2</p><h2 id="中文分词"><a href="#中文分词" class="headerlink" title="中文分词"></a>中文分词</h2><p>Elasticsearch 默认提供了一堆的分词器，比如 <code>standard</code>、<code>whitespace</code>、<code>language(比如english)</code> 等分词器，但是都对中文分词的效果不太好，为了实现更好的搜索效果，我们需要安装第三方分词器来进行分词，比较常见的就是 <code>ik</code> 分词器。</p><p><code>ik</code> 分词器的安装比较简单，首先前往 github 选择与你的 Elasticsearch 相同的版本下载，下载地址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a>，随后解压至 的 <code>plugins/ik/</code> 目录下即可。如下下载 8.2.3 版本：</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /www/server/elasticsearch/plugins</span><br><span class="line"><span class="built_in">mkdir</span> ik</span><br><span class="line"><span class="built_in">cd</span> ik</span><br><span class="line">wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v8.2.3/elasticsearch-analysis-ik-8.2.3.zip</span><br><span class="line">unzip elasticsearch-analysis-ik-8.2.3.zip</span><br><span class="line"><span class="built_in">rm</span> -f elasticsearch-analysis-ik-8.2.3.zip</span><br></pre></td></tr></tbody></table></figure><h2 id="分面搜索"><a href="#分面搜索" class="headerlink" title="分面搜索"></a>分面搜索</h2><p>我们可以在京东上搜索一下『手机』：</p><p><img src="https://cdn.codeover.cn/img/image-20220728220719329.png-imageFop" alt="京东分面搜索"></p><p>我们可以看到京东把一些属性聚合在一起并做成了链接，我们可以点击聚合的链接进一步的筛选商品，这个功能就叫做分面搜索，分面搜索是搜索引擎中非常重要的一个功能，可以帮助用户更方便的搜索想要的商品。</p><p>想要实现分面搜索就需要用到 Elasticsearch 中的聚合，其与 SQL 语句的 <code>group by</code> 有些类似，但更加灵活和强大</p><p>在实现分面搜索之前，我们需要先对索引结构进行调整：</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -H<span class="string">'Content-Type: application/json'</span> -XPUT http://localhost:9200/test_index/_mapping -d<span class="string">'{</span></span><br><span class="line"><span class="string">  "properties": {</span></span><br><span class="line"><span class="string">    "title": { "type": "text", "analyzer": "ik_smart" }, </span></span><br><span class="line"><span class="string">    "description": { "type": "text", "analyzer": "ik_smart" },</span></span><br><span class="line"><span class="string">    "price": { "type": "scaled_float", "scaling_factor": 100 },</span></span><br><span class="line"><span class="string">    "properties": {</span></span><br><span class="line"><span class="string">      "type": "nested",</span></span><br><span class="line"><span class="string">      "properties": {</span></span><br><span class="line"><span class="string">        "name": { "type": "keyword" }, </span></span><br><span class="line"><span class="string">        "value": { "type": "keyword" }</span></span><br><span class="line"><span class="string">      }</span></span><br><span class="line"><span class="string">    }</span></span><br><span class="line"><span class="string">  }</span></span><br><span class="line"><span class="string">}'</span></span><br><span class="line">curl -H<span class="string">'Content-Type: application/json'</span> -XPUT http://localhost:9200/test_index/_doc/1 -d<span class="string">'{</span></span><br><span class="line"><span class="string">    "title": "iPhone XR",</span></span><br><span class="line"><span class="string">    "description": "全新国产",</span></span><br><span class="line"><span class="string">    "price": 12800,</span></span><br><span class="line"><span class="string">    "properties": [{</span></span><br><span class="line"><span class="string">        "name": "品牌名称",</span></span><br><span class="line"><span class="string">        "value": "苹果"</span></span><br><span class="line"><span class="string">    }, {</span></span><br><span class="line"><span class="string">        "name": "机身内存",</span></span><br><span class="line"><span class="string">        "value": "256G"</span></span><br><span class="line"><span class="string">    }]</span></span><br><span class="line"><span class="string">}'</span></span><br><span class="line">curl -H<span class="string">'Content-Type: application/json'</span> -XPUT http://localhost:9200/test_index/_doc/2 -d<span class="string">'{</span></span><br><span class="line"><span class="string">    "title": "VIVO X3",</span></span><br><span class="line"><span class="string">    "description": "全新国产正品",</span></span><br><span class="line"><span class="string">    "price": 3600,</span></span><br><span class="line"><span class="string">    "properties": [{</span></span><br><span class="line"><span class="string">        "name": "品牌名称",</span></span><br><span class="line"><span class="string">        "value": "VIVO"</span></span><br><span class="line"><span class="string">    }, {</span></span><br><span class="line"><span class="string">        "name": "机身内存",</span></span><br><span class="line"><span class="string">        "value": "128G"</span></span><br><span class="line"><span class="string">    }]</span></span><br><span class="line"><span class="string">}'</span></span><br><span class="line">curl -H<span class="string">'Content-Type: application/json'</span> -XPUT http://localhost:9200/test_index/_doc/3 -d<span class="string">'{</span></span><br><span class="line"><span class="string">    "title": "iPhone 13 PLUS",</span></span><br><span class="line"><span class="string">    "description": "全新国行",</span></span><br><span class="line"><span class="string">    "price": 9800,</span></span><br><span class="line"><span class="string">    "properties": [{</span></span><br><span class="line"><span class="string">        "name": "品牌名称",</span></span><br><span class="line"><span class="string">        "value": "苹果"</span></span><br><span class="line"><span class="string">    }, {</span></span><br><span class="line"><span class="string">        "name": "机身内存",</span></span><br><span class="line"><span class="string">        "value": "520G"</span></span><br><span class="line"><span class="string">    }]</span></span><br><span class="line"><span class="string">}'</span></span><br></pre></td></tr></tbody></table></figure><p>可以看到我们在 <code>test_index</code> 索引新增了一个 <code>properties</code> 字段用于储存商品属性，并插入了三条测试文档。接下来我们尝试进行搜索：</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -XPOST -H<span class="string">'Content-Type:application/json'</span> http://localhost:9200/test_index/_search?pretty -d<span class="string">'</span></span><br><span class="line"><span class="string">{</span></span><br><span class="line"><span class="string">	"from": 0,</span></span><br><span class="line"><span class="string">	"size": 10,</span></span><br><span class="line"><span class="string">	"sort": [{</span></span><br><span class="line"><span class="string">		"price": "desc"</span></span><br><span class="line"><span class="string">	}],</span></span><br><span class="line"><span class="string">	"query": {</span></span><br><span class="line"><span class="string">		"bool": {</span></span><br><span class="line"><span class="string">			"must": [{</span></span><br><span class="line"><span class="string">				"multi_match": {</span></span><br><span class="line"><span class="string">					"query": "全新",</span></span><br><span class="line"><span class="string">					"fields": ["title^2", "description"]</span></span><br><span class="line"><span class="string">				}</span></span><br><span class="line"><span class="string">			}]</span></span><br><span class="line"><span class="string">		}</span></span><br><span class="line"><span class="string">	},</span></span><br><span class="line"><span class="string">	"aggs": {</span></span><br><span class="line"><span class="string">		"properties": {</span></span><br><span class="line"><span class="string">			"nested": {</span></span><br><span class="line"><span class="string">				"path": "properties"</span></span><br><span class="line"><span class="string">			},</span></span><br><span class="line"><span class="string">			"aggs": {</span></span><br><span class="line"><span class="string">				"properties": {</span></span><br><span class="line"><span class="string">					"terms": {</span></span><br><span class="line"><span class="string">						"field": "properties.name"</span></span><br><span class="line"><span class="string">					}</span></span><br><span class="line"><span class="string">				}</span></span><br><span class="line"><span class="string">			}</span></span><br><span class="line"><span class="string">		}</span></span><br><span class="line"><span class="string">	}</span></span><br><span class="line"><span class="string">}'</span></span><br></pre></td></tr></tbody></table></figure><p>以上搜索条件返回如下：</p><p><img src="https://cdn.codeover.cn/img/image-20220728231814918.png-imageFop" alt="返回示例"></p><p>以下为对应字段解释</p><figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">'aggs' =&gt; <span class="punctuation">[</span></span><br><span class="line">    <span class="comment">// 这里的 properties 是我们给这个聚合操作的命名</span></span><br><span class="line">    <span class="comment">// 可以是任意字符串，与商品结构里的 properties 没有必然联系</span></span><br><span class="line">    'properties' =&gt; <span class="punctuation">[</span></span><br><span class="line">        <span class="comment">// 由于我们要聚合的属性是在 nested 类型字段下的属性，需要在外面套一层 nested 聚合查询</span></span><br><span class="line">        'nested' =&gt; <span class="punctuation">[</span> </span><br><span class="line">            <span class="comment">// 代表我们要查询的 nested 字段名为 properties</span></span><br><span class="line">            'path' =&gt; 'properties'<span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="comment">// 在 nested 聚合下嵌套聚合</span></span><br><span class="line">        'aggs'   =&gt; <span class="punctuation">[</span></span><br><span class="line">            <span class="comment">// 聚合的名称</span></span><br><span class="line">            'properties' =&gt; <span class="punctuation">[</span></span><br><span class="line">                <span class="comment">// terms 聚合，用于聚合相同的值</span></span><br><span class="line">                'terms' =&gt; <span class="punctuation">[</span></span><br><span class="line">                    <span class="comment">// 我们要聚合的字段名</span></span><br><span class="line">                    'field' =&gt; 'properties.name'<span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></tbody></table></figure><p>返回信息解释：</p><figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 聚合结果</span></span><br><span class="line"><span class="string">"aggregations"</span> =&gt; <span class="punctuation">[</span></span><br><span class="line">  <span class="comment">// 第一层聚合的名称</span></span><br><span class="line">  <span class="string">"properties"</span> =&gt; <span class="punctuation">[</span></span><br><span class="line">    <span class="comment">// 聚合了 6 个文档，即搜索结果中共有 6 个商品属性</span></span><br><span class="line">    <span class="string">"doc_count"</span> =&gt; <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 第二层聚合的名称</span></span><br><span class="line">    <span class="string">"properties"</span> =&gt; <span class="punctuation">[</span></span><br><span class="line">      <span class="string">"doc_count_error_upper_bound"</span> =&gt; <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"sum_other_doc_count"</span> =&gt; <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="comment">// 第二层聚合结果</span></span><br><span class="line">      <span class="string">"buckets"</span> =&gt; <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">          <span class="comment">// properties.name 为『品牌名称』的属性共有 3 个</span></span><br><span class="line">          <span class="string">"key"</span> =&gt; <span class="string">"品牌名称"</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="string">"doc_count"</span> =&gt; <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">          <span class="string">"key"</span> =&gt; <span class="string">"机身内存"</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">"doc_count"</span> =&gt; <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure><p>解决下我们进行第三层聚合，也就是属性值的聚合</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -XPOST -H<span class="string">'Content-Type:application/json'</span> http://localhost:9200/test_index/_search?pretty -d<span class="string">'</span></span><br><span class="line"><span class="string">{</span></span><br><span class="line"><span class="string">	"from": 0,</span></span><br><span class="line"><span class="string">	"size": 10,</span></span><br><span class="line"><span class="string">	"sort": [{</span></span><br><span class="line"><span class="string">		"price": "desc"</span></span><br><span class="line"><span class="string">	}],</span></span><br><span class="line"><span class="string">	"query": {</span></span><br><span class="line"><span class="string">		"bool": {</span></span><br><span class="line"><span class="string">			"must": [{</span></span><br><span class="line"><span class="string">				"multi_match": {</span></span><br><span class="line"><span class="string">					"query": "全新",</span></span><br><span class="line"><span class="string">					"fields": ["title^2", "description"]</span></span><br><span class="line"><span class="string">				}</span></span><br><span class="line"><span class="string">			}]</span></span><br><span class="line"><span class="string">		}</span></span><br><span class="line"><span class="string">	},</span></span><br><span class="line"><span class="string">	"aggs": {</span></span><br><span class="line"><span class="string">		"properties": {</span></span><br><span class="line"><span class="string">			"nested": {</span></span><br><span class="line"><span class="string">				"path": "properties"</span></span><br><span class="line"><span class="string">			},</span></span><br><span class="line"><span class="string">			"aggs": {</span></span><br><span class="line"><span class="string">				"properties": {</span></span><br><span class="line"><span class="string">					"terms": {</span></span><br><span class="line"><span class="string">						"field": "properties.name"</span></span><br><span class="line"><span class="string">					},</span></span><br><span class="line"><span class="string">					"aggs": {</span></span><br><span class="line"><span class="string">						"value": {</span></span><br><span class="line"><span class="string">							"terms": {</span></span><br><span class="line"><span class="string">								"field": "properties.value"</span></span><br><span class="line"><span class="string">							}</span></span><br><span class="line"><span class="string">						}</span></span><br><span class="line"><span class="string">					}</span></span><br><span class="line"><span class="string">				}</span></span><br><span class="line"><span class="string">			}</span></span><br><span class="line"><span class="string">		}</span></span><br><span class="line"><span class="string">	}</span></span><br><span class="line"><span class="string">}'</span></span><br></pre></td></tr></tbody></table></figure><p><img src="https://cdn.codeover.cn/img/image-20220728232629770.png-imageFop" alt="第三层聚合"></p><p>此时可以看到几乎已实现类似于京东分面搜索的功能。</p><h2 id="同义词搜索"><a href="#同义词搜索" class="headerlink" title="同义词搜索"></a>同义词搜索</h2><p>在前面的内容中，我们实现了基本的搜索，某个文档要想在某个关键词搜索结果中出现，就必须在文档内容中出现该关键词，这样就需要给商品配置巨量的关键词才能让商品出现的频率提高， 对运营管理人员不甚友好。为了解决这个问题，我们就需要让搜索引擎支持 <em>同义词搜索</em>，比如用户搜索「苹果手机」，那么包含 「Iphone」 的文档也会出现在搜索结果中。</p><p>作为目前最强大的搜索引擎之一，Elasticsearch 是默认支持 <em>同义词搜索</em> 的。</p><h3 id="分析器"><a href="#分析器" class="headerlink" title="分析器"></a>分析器</h3><p>Elasticsearch 的分析器是由 「字符过滤器」、「分词器」与「字符过滤器」三部分组成，Elasticsearch 内置了一些 「分析器」，同时也允许我们自行定义分析器。</p><ul><li><strong>字符过滤器</strong>：「字符过滤器」会以字符为单位，根据一定的规则去添加、删除、替换原始字符串，比如将汉字的 「一二三四」替换成阿拉伯数字「1234」，一个「分析器」可以包含 0 个或多个「字符过滤器」。</li><li><strong>分词器</strong>：「分词器」是根据一定的规则，将原始字符串拆分成一组组的词语，比如前文介绍的 <code>ik_smart</code> 分词器，其可以将「苹果手机」拆分成「苹果」和「手机」两个词语，一个「分析器」有且仅能有一个「分词器」。</li><li><strong>词语过滤器</strong>：「词语过滤器」会根据「分词器」的分词结果，以词语为单位，根据一定的规则去添加、删除、替换词句，例如同义词过滤器 <code>synonym</code> 可以将「西红柿」替换为 「西红柿」+「番茄」两个词，一个「分析器」可以包含 0 个或多个「词语过滤器」。</li></ul><h3 id="自定义分析器"><a href="#自定义分析器" class="headerlink" title="自定义分析器"></a>自定义分析器</h3><p>首先我们先创建同义词对应关系的文本文件，格式形如 <code>iPhone,苹果手机 =&gt; iPhone,苹果手机</code>，每行一组关键词：</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /www/server/elasticsearch/config/</span><br><span class="line"><span class="built_in">mkdir</span> analysis</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"iPhone,苹果手机 =&gt; iPhone,苹果手机"</span> &gt; analysis/synonyms.txt</span><br></pre></td></tr></tbody></table></figure><p>接下来我们创建一个自定义分析器，我们创建一个新的索引来测试，Elasticsearch 支持在创建索引的同时创建「分析器」：</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -XPUT -H<span class="string">'Content-Type: application/json'</span> http://localhost:9200/test_synonym?pretty -d<span class="string">' </span></span><br><span class="line"><span class="string">{</span></span><br><span class="line"><span class="string">  "settings": {</span></span><br><span class="line"><span class="string">    "index": {</span></span><br><span class="line"><span class="string">      "analysis": {</span></span><br><span class="line"><span class="string">        "filter": {</span></span><br><span class="line"><span class="string">          "synonym_filter": {</span></span><br><span class="line"><span class="string">            "type": "synonym",</span></span><br><span class="line"><span class="string">            "synonyms_path": "analysis/synonyms.txt",</span></span><br><span class="line"><span class="string">            "updateable":  true</span></span><br><span class="line"><span class="string">          }</span></span><br><span class="line"><span class="string">        },</span></span><br><span class="line"><span class="string">        "analyzer": {</span></span><br><span class="line"><span class="string">          "ik_smart_synonym": {</span></span><br><span class="line"><span class="string">            "type": "custom",</span></span><br><span class="line"><span class="string">            "tokenizer": "ik_smart",</span></span><br><span class="line"><span class="string">            "filter": ["synonym_filter"]</span></span><br><span class="line"><span class="string">          }</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">      }</span></span><br><span class="line"><span class="string">    }</span></span><br><span class="line"><span class="string">  }</span></span><br><span class="line"><span class="string">}'</span></span><br></pre></td></tr></tbody></table></figure><p>在这个请求中我们在 <code>analysis</code> 下的 <code>filter</code> 中定义了一个名为 <code>synonym_filter</code> 的『同义词词语过滤器』，并且指定同义词的字典路径为 <code>analysis/synonyms.txt</code>；同时在 <code>analyzer</code> 下定义了一个名为 <code>ik_smart_synonym</code> 的「自定义分析器」，并指定 <code>ik_smart</code> 作为「分词器」，上面定义的 <code>synonym_filter</code> 作为「词语过滤器」。</p><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>我们来测试一下这个分析器的效果：</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">curl -H<span class="string">'Content-Type: application/json'</span> http://localhost:9200/test_synonym/_analyze?pretty -d <span class="string">'{"text": "苹果手机","analyzer":"ik_smart_synonym"}'</span></span><br></pre></td></tr></tbody></table></figure><p>返回内容如下：</p><figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"tokens"</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"token"</span> <span class="punctuation">:</span> <span class="string">"iphone"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"start_offset"</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"end_offset"</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"type"</span> <span class="punctuation">:</span> <span class="string">"SYNONYM"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"position"</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"token"</span> <span class="punctuation">:</span> <span class="string">"苹果"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"start_offset"</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"end_offset"</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"type"</span> <span class="punctuation">:</span> <span class="string">"SYNONYM"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"position"</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"token"</span> <span class="punctuation">:</span> <span class="string">"手机"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"start_offset"</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"end_offset"</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"type"</span> <span class="punctuation">:</span> <span class="string">"SYNONYM"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"position"</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p>可以看到「分析器」将关键词 <code>苹果手机</code> 拆分成为了 <code>iphone</code> 、 <code>苹果</code> 与 <code>手机</code> 三个词。</p><h2 id="在-php-中使用-Elasticsearch"><a href="#在-php-中使用-Elasticsearch" class="headerlink" title="在 php 中使用 Elasticsearch"></a>在 php 中使用 Elasticsearch</h2><ol><li>引入 Composer 包</li></ol><p>Elasticsearch 官方提供了 Composer 包，因为不同版本的 Elasticsearch 的 API 略有不同，所以在引入时需要注意要指定版本，例如引入 <code>8.x</code> 版本：</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">composer require elasticsearch/elasticsearch <span class="string">'^7.0'</span></span><br></pre></td></tr></tbody></table></figure><ol start="2"><li>实例化 Elasticsearch 实例</li></ol><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable">$builder</span> = <span class="title class_">Elastic\Elasticsearch\ClientBuilder</span>::<span class="title function_ invoke__">create</span>()-&gt;<span class="title function_ invoke__">setHosts</span>([<span class="string">'localhost:9200'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$client</span> = <span class="variable">$builder</span>-&gt;<span class="title function_ invoke__">build</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 test_index 索引中 ID 为 1 的文档</span></span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">get</span>([<span class="string">'index'</span> =&gt; <span class="string">'test_index'</span>, <span class="string">'id'</span> =&gt; <span class="number">1</span>]);</span><br></pre></td></tr></tbody></table></figure><p>SDK 详细使用说明可参考官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/php/current/_quickstart.html">https://www.elastic.co/guide/cn/elasticsearch/php/current/_quickstart.html</a></p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none;padding-left:0;margin-left:40px"><li id="fn:1"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">1.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">JDK 全称 <strong>Java Development Kit</strong>。它是 Java 语言的软件开发工具包，主要用于移动设备、嵌入式设备上的 java 应用程序。JDK 是整个 java 开发的核心，它包含了 JAVA 的运行环境（JVM+Java 系统类库）和 JAVA 工具。 <a href="#fnref:1" rev="footnote">↩</a></span></li><li id="fn:2"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">2.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">x-pack 是 elasticsearch 的一个扩展包，集安全，警告，监视，图形和报告功能于一体，可以轻松的启用或者关闭一些功能。 <a href="#fnref:2" rev="footnote">↩</a></span></li></ol></div></div></div><div class="top-div"><ol class="top-box"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%AE%89%E8%A3%85"><span class="top-box-text">安装</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%AE%89%E8%A3%85-JDK"><span class="top-box-text">安装 JDK</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85-Elasticsearch"><span class="top-box-text">下载并安装 Elasticsearch</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E8%BF%90%E8%A1%8C"><span class="top-box-text">运行</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95"><span class="top-box-text">连接测试</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="top-box-text">基础概念</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C"><span class="top-box-text">基础操作</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#Elasticsearch-%E6%9F%A5%E8%AF%A2"><span class="top-box-text">Elasticsearch 查询</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D"><span class="top-box-text">中文分词</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%88%86%E9%9D%A2%E6%90%9C%E7%B4%A2"><span class="top-box-text">分面搜索</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%90%8C%E4%B9%89%E8%AF%8D%E6%90%9C%E7%B4%A2"><span class="top-box-text">同义词搜索</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%88%86%E6%9E%90%E5%99%A8"><span class="top-box-text">分析器</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E6%9E%90%E5%99%A8"><span class="top-box-text">自定义分析器</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%9C%A8-php-%E4%B8%AD%E4%BD%BF%E7%94%A8-Elasticsearch"><span class="top-box-text">在 php 中使用 Elasticsearch</span></a></li></ol></div></div></div><div class="next-post"><a class="purple-link" href="/laravel-admin-lang/"><h3 class="post-title"> 下一篇：laravel-admin 根据路由自动切换语言包</h3></a></div></div><div id="gitalk-container"></div><footer><div class="site-footer"><div class="social-container"><a href="https://github.com/f-dong" target="_blank"><i class="icon icon-github"></i></a></div> Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a> | <a class="icp" href="https://beian.miit.gov.cn" target="_blank">豫ICP备2022011962号</a> | <a class="icp" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41010402002848" target="_blank">豫公网安备41010402002848号</a></div></footer></div><script src="/js/jquery.min.js"></script><script src="/js/jquery.fancybox.min.js"></script><script src="/js/main.js"></script><script src="/js/gitalk.min.js"></script><script>var gitalk=new Gitalk({clientID:"eaa8ec37487184406145",clientSecret:"77f9955d0267c1331df7cc706cfa385d2befb9c6",repo:"blog",owner:"f-dong",admin:["f-dong"],id:location.pathname.slice(1,location.pathname.lastIndexOf("/")).substring(0,49),distractionFreeMode:!1,createIssueManually:!0});gitalk.render("gitalk-container")</script></body></html>