<!DOCTYPE html><html lang="zh-CN"><head><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><meta charset="utf-8"><title>Nginx 日志配置</title><meta name="keywords" content="Nginx,Nginx 日志配置,linux,nginx logs,服务器搭建"><meta name="description" content="Nginx 日志对于统计、系统服务排错很有用, 通过访问日志我们可以得到用户的IP地址、浏览器的信息，请求的处理时间等信息。错误日志记录了访问出错的信息，可以帮助我们快速定位错误的原因。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/style/main.css"><link rel="stylesheet" href="/style/jquery.fancybox.min.css"><link rel="stylesheet" href="/style/gitalk.css"><script async src="https://www.googletagmanager.com/gtag/js?id=G-2GM6102E19"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2GM6102E19")</script><link rel="alternate" href="/atom.xml" title="codeover" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="codeover" type="application/rss+xml"></head><body><div id="app" class="main"><div class="site-header-container"><div class="site-header"><div class="left"> <a href="https://www.codeover.cn"><img class="avatar" src="/images/avatar.png" alt="logo" width="32px" height="32px"></a><a href="https://www.codeover.cn"><h1 class="site-title">codeover</h1></a></div><div class="right"><i class="icon menu-switch icon-menu-outline"></i></div></div></div><div class="menu-container" style="height:0;opacity:0"><nav class="menu-list"> <a href="/" class="menu purple-link">首页</a> <a href="/tags/" class="menu purple-link">标签</a> <a href="/categories/" class="menu purple-link">分类</a> <a href="/archives/" class="menu purple-link">归档</a> <a href="/about/" class="menu purple-link">关于</a></nav></div><div class="content-container"><div class="post-detail"><h2 class="post-title">Nginx 日志配置</h2><div class="post-info post-detail-info"><span><i class="icon icon-calendar-outline"></i> 2022-04-20</span><span><i class="icon icon-pricetags-outline"></i> <a href="/tags/linux/">linux ，</a> <a href="/tags/Nginx/">Nginx</a></span></div><div class="post-content-wrapper"><div class="post-content"><h2 id="设置-access-log"><a href="#设置-access-log" class="headerlink" title="设置 access_log"></a>设置 access_log</h2><h3 id="access-log-语法"><a href="#access-log-语法" class="headerlink" title="access_log 语法"></a>access_log 语法</h3><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">access_log</span> path [format] [buffer=size] [gzip[=level]] [flush=time] [if=condition];</span><br></pre></td></tr></tbody></table></figure><ul><li><code>path</code> 指定日志的存储路径</li><li><code>format</code> 指定日志的格式</li><li><code>buffer</code> 指定日志写入时的缓存大小</li><li><code>gzip</code> 日志写入前进行压缩，压缩比例 1 到 9 数值越大压缩率越高, 同时 cpu 消耗也越大, 默认为1</li><li><code>flush</code> 缓存的有效时间, 如果超过此时间, 缓存中的内容会被清空</li><li><code>if</code> 条件判断, 如果指定的条件不满足, 则不会写入日志</li></ul><h3 id="format-语法"><a href="#format-语法" class="headerlink" title="format 语法"></a>format 语法</h3><p>Nginx 预定义了日志格式，如果没有明确指定日志格式默认使用该格式：</p><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] '</span></span><br><span class="line">                  <span class="string">'"<span class="variable">$request</span>" <span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> '</span></span><br><span class="line">                  <span class="string">'"<span class="variable">$http_referer</span>" "<span class="variable">$http_user_agent</span>"'</span></span><br></pre></td></tr></tbody></table></figure><p>如果不想使用 Nginx 预定义的格式，可以通过 format 指令来自定义。</p><p>下面是 <code>format</code> 指令中常用的一些变量：</p><table><thead><tr><th align="left">变量</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">$bytes_sent</td><td align="left">发送给客户端的总字节数</td></tr><tr><td align="left">$body_bytes_sent</td><td align="left">发送给客户端的字节数，不包括响应头的大小</td></tr><tr><td align="left">$connection</td><td align="left">连接序列号</td></tr><tr><td align="left">$connection_requests</td><td align="left">当前通过连接发出的请求数量</td></tr><tr><td align="left">$msec</td><td align="left">日志写入时间，单位为秒，精度是毫秒</td></tr><tr><td align="left">$pipe</td><td align="left">如果请求是通过http流水线发送，则其值为”p”，否则为“.”</td></tr><tr><td align="left">$request_length</td><td align="left">请求长度（包括请求行，请求头和请求体）</td></tr><tr><td align="left">$request_time</td><td align="left">请求处理时长，单位为秒，精度为毫秒，从读入客户端的第一个字节开始，直到把最后一个字符发送张客户端进行日志写入为止</td></tr><tr><td align="left">$status</td><td align="left">响应状态码</td></tr><tr><td align="left">$time_iso8601</td><td align="left">标准格式的本地时间,形如“2017-05-24T18:31:27+08:00”</td></tr><tr><td align="left">$time_local</td><td align="left">通用日志格式下的本地时间，如”24/May/2017:18:31:27 +0800”</td></tr><tr><td align="left">$http_referer</td><td align="left">请求的referer地址</td></tr><tr><td align="left">$http_user_agent</td><td align="left">客户端浏览器信息</td></tr><tr><td align="left">$remote_addr</td><td align="left">客户端IP</td></tr><tr><td align="left">$http_x_forwarded_for</td><td align="left">当前端有代理服务器时，设置web节点记录客户端地址的配置，此参数生效的前提是代理服务器也要进行相关的x_forwarded_for设置</td></tr><tr><td align="left">$request</td><td align="left">完整的原始请求行，如 “GET / HTTP/1.1”</td></tr><tr><td align="left">$remote_user</td><td align="left">客户端用户名称，仅针对启用了用户认证的请求</td></tr><tr><td align="left">$request_uri</td><td align="left">完整的请求地址，如 “<a target="_blank" rel="noopener" href="https://nginx.org/">https://nginx.org</a>“</td></tr></tbody></table><p>测试</p><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                  <span class="string">'"<span class="variable">$request_uri</span>" <span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                  <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"><span class="attribute">access_log</span> /var/logs/access.log main</span><br></pre></td></tr></tbody></table></figure><p>假如客户端有发起请求：<a target="_blank" rel="noopener" href="https://example.com,/">https://example.com，</a> 我们看一下一个请求的日志记录:</p><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">115.60.176.39 - [20/Apr/2022:22:06:20 +0800] "GET / HTTP/1.1" "https://example.com" 200 160 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36" "-"</span><br></pre></td></tr></tbody></table></figure><p>日志记录中 <code>$remote_user</code>、<code>$http_referer</code>、<code>$http_x_forwarded_for</code> 都对应了一个 <code>-</code> ，这是因为这几个变量为空。</p><h2 id="设置-error-log"><a href="#设置-error-log" class="headerlink" title="设置 error_log"></a>设置 error_log</h2><p>错误日志在 Nginx 中是通过 <code>error_log</code> 指令实现的。该指令记录服务器和请求处理过程中的错误信息。</p><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">error_log</span> file [level];</span><br></pre></td></tr></tbody></table></figure><ul><li><code>file</code> 指定日志的写入位置</li><li><code>level</code> 指定错误级别, 可选值从低到高依次是 <code>debug</code>, <code>info</code>, <code>notice</code>, <code>warn</code>, <code>error</code>, <code>crit</code>, <code>alert</code>, <code>emerg</code> 只有设置日志的错误级别等于或高于 <code>level</code> 指定的值才会写入错误日志中。默认值是 <code>error</code></li></ul><h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">error_log</span> /var/logs/nginx/<span class="literal">error</span>.log</span><br></pre></td></tr></tbody></table></figure><p>例子中指定了错误日志的路径为：<code>/var/logs/nginx/error.log</code>, 日志级别使用默认的 <code>error</code></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Nginx 中通过 <code>access_log</code> 和 <code>error_log</code> 指令配置访问日志和错误日志，通过 <code>log_format</code> 我们可以自定义日志格式。</p></div><div class="top-div"><ol class="top-box"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E8%AE%BE%E7%BD%AE-access-log"><span class="top-box-text">设置 access_log</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#access-log-%E8%AF%AD%E6%B3%95"><span class="top-box-text">access_log 语法</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#format-%E8%AF%AD%E6%B3%95"><span class="top-box-text">format 语法</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E8%AE%BE%E7%BD%AE-error-log"><span class="top-box-text">设置 error_log</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E8%AF%AD%E6%B3%95"><span class="top-box-text">语法</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="top-box-text">基本用法</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E6%80%BB%E7%BB%93"><span class="top-box-text">总结</span></a></li></ol></div></div></div><div class="next-post"><a class="purple-link" href="/centos-install-nginx/"><h3 class="post-title"> 下一篇：Centos 编译安装 Nginx</h3></a></div></div><div id="gitalk-container"></div><footer><div class="site-footer"><div class="social-container"><a href="https://github.com/f-dong" target="_blank"><i class="icon icon-github"></i></a></div> Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a> | <a class="icp" href="https://beian.miit.gov.cn" target="_blank">豫ICP备2022011962号</a> | <a class="icp" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41010402002848" target="_blank">豫公网安备41010402002848号</a></div></footer></div><script src="/js/jquery.min.js"></script><script src="/js/jquery.fancybox.min.js"></script><script id="hexo-configurations">window.theme_config={},window.is_post=!0</script><script src="/js/main.js"></script><script src="/js/gitalk.min.js"></script><script>var gitalk=new Gitalk({clientID:"eaa8ec37487184406145",clientSecret:"77f9955d0267c1331df7cc706cfa385d2befb9c6",repo:"blog",owner:"f-dong",admin:["f-dong"],id:location.pathname.slice(1,location.pathname.lastIndexOf("/")).substring(0,49),distractionFreeMode:!1,createIssueManually:!0});gitalk.render("gitalk-container")</script></body></html>