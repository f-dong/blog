<!DOCTYPE html><html lang="zh-CN"><head><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><meta charset="utf-8"><title>Nginx web server 配置</title><meta name="keywords" content="Nginx,Nginx server配置,linux,服务器搭建,反向代理"><meta name="description" content="nginx web server就是虚拟网站配置，每个server都对应了一个网站，本文介绍了如何配置nginx web server, 以及反向代理的配置等，从语法与示例讲解。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/style/main.css"><link rel="stylesheet" href="/style/jquery.fancybox.min.css"><link rel="stylesheet" href="/style/gitalk.css"><script async src="https://hm.baidu.com/hm.js?d2296a1777ed197c034326f14f8630c2"></script><link rel="alternate" href="/atom.xml" title="codeover" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="codeover" type="application/rss+xml"></head><body><div id="app" class="main"><div class="site-header-container"><div class="site-header"><div class="left"> <a href="https://www.codeover.cn"><img class="avatar" src="/images/avatar.png" alt="" width="32px" height="32px"></a><a href="https://www.codeover.cn"><h1 class="site-title">codeover</h1></a></div><div class="right"><i class="icon menu-switch icon-menu-outline"></i></div></div></div><div class="menu-container" style="height:0;opacity:0"><nav class="menu-list"> <a href="/" class="menu purple-link">首页</a> <a href="/tags/" class="menu purple-link">标签</a> <a href="/categories/" class="menu purple-link">分类</a> <a href="/archives/" class="menu purple-link">归档</a> <a href="/about/" class="menu purple-link">关于</a></nav></div><div class="content-container"><div class="post-detail"><h2 class="post-title">Nginx web server 配置</h2><div class="post-info post-detail-info"><span><i class="icon icon-calendar-outline"></i> 2022-04-26</span><span><i class="icon icon-pricetags-outline"></i> <a href="/tags/linux/">linux ，</a> <a href="/tags/Nginx/">Nginx</a></span></div><div class="post-content-wrapper"><div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Nginx 配置文件中至少包含一条定义虚拟服务器的 <code>server</code> 指令, 当 Nginx 处理一个请求时，第一个被选中的虚拟服务器将用于处理该请求</p><p>虚拟服务器通过 <code>http</code> 指令中的 <code>server</code> 指令来定义，示例如下:</p><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">http</span> {</span><br><span class="line">    <span class="section">server</span> {</span><br><span class="line">    </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><code>http</code> 中可包含多个 <code>server</code> 来指定多个虚拟服务器, 这些虚拟服务器统一由 nginx 进行分发，互相隔离。</p><h2 id="listen-指令"><a href="#listen-指令" class="headerlink" title="listen 指令"></a>listen 指令</h2><p>正常情况下每个 <code>server</code> 中都会包含一条 <code>listen</code> 指令, 用于指定该虚拟服务器要监听的 IP 地址以及端口, 例如:</p><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">server</span> {</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">0.0.0.0:80</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>如果不填写端口，则采用默认端口(80), 如果不填写 IP 地址，则监听所有地址。</p><h2 id="server-name-指令"><a href="#server-name-指令" class="headerlink" title="server_name 指令"></a>server_name 指令</h2><p>nginx 根据请求中的 <code>host</code> 头部与 <code>server_name</code> 进行匹配，来进行请求的分发, 如果都没有匹配或者请求中根本就不包含 <code>host</code> 头部, nginx 会将请求路由默认的虚拟主机。<code>server_name</code> 有三种不同的配置格式，且不用配置格式的优先级也不相同。</p><h3 id="通配符匹配"><a href="#通配符匹配" class="headerlink" title="通配符匹配"></a>通配符匹配</h3><p>通配符格式中的 <code>*</code> 号只能在域名的开头或结尾，并且 <code>*</code> 号两侧只能是 <code>.</code> ，所以 <code>www.*.example.com</code> 和 <code>w*.example.com</code> 是无效的。<code>*</code> 号可以匹配多个域名部分，<code>*.example.com</code> 不仅与 <code>www.example.com</code> 匹配，而且也与 <code>www.sub.example.org</code> 匹配。<br><code>.example.com</code> 是比较特殊的通配符格式, 可以同时匹配确切名称 <code>example.com</code> 和通配符名称 <code>*.example.com</code> , 例如:</p><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">server</span> {</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  <span class="regexp">*.example.org</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> {</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  <span class="regexp">abc.*</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="正则匹配"><a href="#正则匹配" class="headerlink" title="正则匹配"></a>正则匹配</h3><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">server</span> {</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  ~^(?&lt;user&gt;.+)\.example\.net$;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>正则匹配格式，必须以 <code>~</code> 开头，比如：<code>server_name ~^www\d+\.example\.com$;</code>。如果开头没有 <code>~</code> ，则 nginx 认为是精确匹配。在逻辑上，需要添加 <code>^</code> 和 <code>$</code> 锚定符号。正则表达式命名捕获的变量可以在 nginx 进行引用，例如:</p><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">server</span> {</span><br><span class="line">    <span class="attribute">server_name</span>   ~^(www\.)?(?&lt;domain&gt;.+)$;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / {</span><br><span class="line">        <span class="attribute">root</span>   /sites/<span class="variable">$domain</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="精确匹配"><a href="#精确匹配" class="headerlink" title="精确匹配"></a>精确匹配</h3><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">server</span> {</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  example.org  www.example.org;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>精确匹配就是完整匹配域名</p><h3 id="匹配顺序"><a href="#匹配顺序" class="headerlink" title="匹配顺序"></a>匹配顺序</h3><p>如果有多个 <code>server_name</code> 匹配 <code>host</code> 字段, Nginx 根据以下规则选择第一个相匹配的 <code>server</code> 处理请求:</p><ol><li>精确匹配</li><li>以 <code>*</code> 开始的最长通配符，如 <code>*.example.org</code></li><li>以 <code>*</code> 结尾的最长通配符，如 <code>mail.*</code></li><li>第一个匹配的正则表达式（根据在配置文件中出现的先后顺序）</li></ol><h2 id="location-指令"><a href="#location-指令" class="headerlink" title="location 指令"></a>location 指令</h2><p>location 指令是 nginx 中最关键的指令之一，location 指令的功能是用来匹配不同的 URI 请求，进而对请求做不同的处理和响应。</p><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>Location 块通过指定模式来与客户端请求的URI相匹配。<br>Location 基本语法：</p><ul><li>匹配 URI 类型，有四种参数可选，当然也可以不带参数。</li><li>命名 location，用 <code>@</code> 来标识，类似于定义 goto 语句块。</li></ul><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">location</span> [ = | <span class="regexp">~ |</span> <span class="regexp">~* |</span><span class="regexp"> ^~</span> ] /URI { … }</span><br><span class="line"><span class="section">location</span> @/name/ { … }</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th>参数</th><th>解释</th></tr></thead><tbody><tr><td>空</td><td>location 后没有参数直接跟着 标准 URI，表示前缀匹配，代表跟请求中的 URI 从头开始匹配</td></tr><tr><td>=</td><td>精准匹配，请求字符串与其精准匹配，成功则立即处理，停止搜索其他匹配</td></tr><tr><td>^~</td><td>前缀匹配，请求字符串头部与其匹配，成功则立即处理，停止搜索其他匹配，一般用来匹配目录</td></tr><tr><td>~</td><td>正则匹配，表示 URI 中包含正则表达式， 区分大小写</td></tr><tr><td>~*</td><td>正则匹配，表示 URI 中包含正则表达式， 不区分大小写</td></tr></tbody></table><h3 id="匹配顺序-1"><a href="#匹配顺序-1" class="headerlink" title="匹配顺序"></a>匹配顺序</h3><p>location 的匹配并不是完全的按照其在配置文件中出现的顺序来匹配的，请求 URI 会按如下规则进行规则进行匹配:</p><ol><li>先精准匹配 <strong><code>=</code></strong> ，精准匹配成功则会立即停止其他类型匹配；</li><li>没有精准匹配成功时，进行前缀匹配。先查找带有 <strong><code>^~</code></strong> 的前缀匹配，带有 <strong><code>^~</code></strong> 的前缀匹配成功则立即停止其他类型匹配，普通前缀匹配（不带参数 <strong><code>^~</code></strong> ）成功则会暂存，继续查找正则匹配；</li><li><strong><code>=</code></strong> 和 <strong><code>^~</code></strong> 均未匹配成功前提下，查找正则匹配 <strong><code>~</code></strong> 和 <strong><code>~\*</code></strong> 。当同时有多个正则匹配时，按其在配置文件中出现的先后顺序前后匹配，命中则立即停止其他类型匹配；</li><li>所有正则匹配均未成功时，返回步骤 2 中暂存的普通前缀匹配（不带参数 <strong><code>^~</code></strong> ）的结果 （如有多个匹配则取最长匹配返回）</li></ol><p>以上规则优先级从高到低依次是</p><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">1. location =    # 精准匹配</span><br><span class="line">2. location ^~   # 前缀匹配</span><br><span class="line">3. location ~    # 正则匹配（区分大小写）</span><br><span class="line">4. location ~*   # 正则匹配（不区分大小写）</span><br><span class="line">5. location /a   # 普通前缀匹配，优先级低于带参数前缀匹配。</span><br><span class="line">6. location /    # 任何没有匹配成功的，就会匹配这里处理</span><br></pre></td></tr></tbody></table></figure><h3 id="图片防盗链"><a href="#图片防盗链" class="headerlink" title="图片防盗链"></a>图片防盗链</h3><p>在 Nginx上配置图片防盗链非常简单，通过用户客户端 http 请求头中的 referer 信息来做为主要判断，如果图片链接嵌套在非指定的网站上，可以限制其访问。</p><p>主要配置如下：</p><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">location</span> ~*\.(gif|jpg|jpeg|png|bmp|swf|webp)$ { </span><br><span class="line">     <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> <span class="regexp">*.example.org</span> ~\.google\. ~\.baidu\. ~\.bing\.;</span><br><span class="line">     <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) {</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    } </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ol><li><p>location 中指定要防盗链的文件类型;</p></li><li><p>valid_referers 指定资源访问是通过以下几种方式为合法</p><ul><li><p><code>none</code>: 直接通过 url 访问，无 referer 值的情况</p></li><li><p><code>blocked</code>: referer 值被防火墙修改</p></li><li><p><code>*.example.org</code>: 指定资源在合法的 *.example.org 中可以被引用，支持 <code>*</code> 通配符</p></li><li><p><code>~\.google\.</code>: 指定资源在搜索引擎中可访问</p></li></ul></li><li><p>valid_referers 如果匹配不上，<code>$invalid_referer</code> 的值为 1，if 判断如果 <code>$invalid_referer</code> 为 1 则返回 403 错误码</p></li></ol><h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p>反向代理就是后端服务不直接对外暴露，请求首先发送到 nginx，然后 nginx 将请求转发至后端服务器，比如 <code>tomcat</code> <code>php</code> 等，如果后端服务只有一台服务器，nginx 在这里就是起到了代理后端服务接收请求的作用，称之为反向代理。</p><p>配置代码</p><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">server</span> {</span><br><span class="line">	<span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">	<span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">	<span class="section">location</span> / {</span><br><span class="line">		<span class="attribute">proxy_pass</span>  http://127.0.0.1:8080;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>如上配置，<code>Nginx</code>监听 <code>80</code> 端口，故访问该服务器时，会将请求转发至 <code>127.0.0.1:8080</code> 处理，并将 <code>127.0.0.1:8080</code> 返回的结果原样返回。</p></div><div class="top-div"><ol class="top-box"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#listen-%E6%8C%87%E4%BB%A4"><span class="top-box-text">listen 指令</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#server-name-%E6%8C%87%E4%BB%A4"><span class="top-box-text">server_name 指令</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E5%8C%B9%E9%85%8D"><span class="top-box-text">通配符匹配</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D"><span class="top-box-text">正则匹配</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E7%B2%BE%E7%A1%AE%E5%8C%B9%E9%85%8D"><span class="top-box-text">精确匹配</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%8C%B9%E9%85%8D%E9%A1%BA%E5%BA%8F"><span class="top-box-text">匹配顺序</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#location-%E6%8C%87%E4%BB%A4"><span class="top-box-text">location 指令</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E8%AF%AD%E6%B3%95"><span class="top-box-text">语法</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%8C%B9%E9%85%8D%E9%A1%BA%E5%BA%8F-1"><span class="top-box-text">匹配顺序</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%9B%BE%E7%89%87%E9%98%B2%E7%9B%97%E9%93%BE"><span class="top-box-text">图片防盗链</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="top-box-text">反向代理</span></a></li></ol></li></ol></div></div></div><div class="next-post"><a class="purple-link" href="/nginx-log-config/"><h3 class="post-title"> 下一篇：Nginx 日志配置</h3></a></div></div><div id="gitalk-container"></div><footer><div class="site-footer"><div class="social-container"><a href="https://github.com/f-dong" target="_blank"><i class="icon icon-github"></i></a></div> Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a> | <a class="icp" href="https://beian.miit.gov.cn" target="_blank">豫ICP备2022011962号</a> | <a class="icp" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41010402002848" target="_blank">豫公网安备41010402002848号</a></div></footer></div><script src="/js/jquery.min.js"></script><script src="/js/jquery.fancybox.min.js"></script><script src="/js/main.js"></script><script src="/js/gitalk.min.js"></script><script>var gitalk=new Gitalk({clientID:"eaa8ec37487184406145",clientSecret:"77f9955d0267c1331df7cc706cfa385d2befb9c6",repo:"blog",owner:"f-dong",admin:["f-dong"],id:location.pathname.slice(1,location.pathname.lastIndexOf("/")).substring(0,49),distractionFreeMode:!1,createIssueManually:!0});gitalk.render("gitalk-container")</script></body></html>